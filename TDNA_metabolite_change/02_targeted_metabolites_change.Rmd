---
title: "Analysis of metabolite changes in SALK lines"
author: "Thomas Naake"
date: "04/07/2021"
fig_width: 15
fig_height: 10
output: 
    html_document:
        toc: true
        theme: united
        toc_depth: 3
        toc_float: TRUE
        number_sections: true
        highlight: tango
        self_contained: no
---
    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dev = "pdf")
knitr::opts_knit$set(root.dir = "~/GitHub/GWAS_arabidopsis_seed/")
```

```{r load_packages, echo = FALSE}
suppressPackageStartupMessages(library("SummarizedExperiment"))
suppressPackageStartupMessages(library("MatrixQCvis"))
```

```{r functions, echo = FALSE}
## create function to get metabolites
get_metabolite <- function(pl, mz, rt) {
    rt <- rt * 60
    pl[pl[, "mz"] < mz + 0.01 & pl[, "mz"] > mz - 0.01 &
           pl[, "rt"] < rt + 60 & pl[, "rt"] > rt - 60, ] 
}
```


# Analysis

## Load the seed weights
```{r load_weights}
options(stringsAsFactors = FALSE)

## rep1
weights_rep1 <- openxlsx::read.xlsx("TDNA_rep1/mutant_lines_lc_weight.xlsx",
    sheet = 1)
weights_rep1$genotype <- gsub(weights_rep1$genotype, pattern = "[.]", 
    replacement = "_")
colnames(weights_rep1)[4] <- "weight"
weights_rep1_old <- weights_rep1

## rep2
weights_rep2 <- openxlsx::read.xlsx("TDNA_rep2/mutant_lines_lc_weight_repl2.xlsx",
    sheet = 1)
weights_rep2$genotype <- gsub(weights_rep2$genotype, pattern = "[.]", 
    replacement = "_")
colnames(weights_rep2)[4] <- "weight"
weights_rep2_old <- weights_rep2 
```

## Negative mode

### Load and prepare the data 
```{r load_negative}
################################################################################
################################# negative mode ################################
################################################################################
## rep1
rep1 <- read.table("TDNA_rep1/neg/TDNA_replicate1_neg_peaklist.txt", 
    header = TRUE, sep = "\t")
colnames(rep1) <- gsub(colnames(rep1), pattern = "_neg", replacement = "")
rep1[rep1 == 0] <- NA

## rep2
rep2 <- read.table("TDNA_rep2/neg/raw_number_vial/TDNA_replicate2_neg_peaklist.txt", 
    header = TRUE, sep = "\t")
colnames(rep2) <- gsub(colnames(rep2), pattern = "_neg", replacement = "")
rep2[rep2 == 0] <- NA
```

Check data quality with `shinyQC`.
```{r shinyQC_prep_rep1}
## rep1
cols <- which(colnames(rep1) == "Col_0_1"):which(colnames(rep1) == "SALK_204674C_3_5")
a <- rep1[, cols] |> as.matrix()
rows_rem <- apply(a, 1, function(x) sum(is.na(x))) > 120
rD <- rep1[, c("mz", "rt", "npeaks", "adduct", "pcgroup")]
a <- a[!rows_rem, ]
rD <- rD[!rows_rem, ]
cD <- data.frame(name = colnames(rep1)[cols])
cD <- dplyr::left_join(cD, weights_rep1, by = c("name" = "genotype"))
cD$genotype <- unlist(lapply(strsplit(cD$name, split = "_"), function(x)
    paste(x[1], x[2], sep = "_")))
cD$batch <- ifelse(cD$injection_vial < 60, "1", "2")
se_rep1 <- SummarizedExperiment::SummarizedExperiment(assays = a, rowData = rD, colData = cD)
rownames(se_rep1) <- paste("feature", seq_len(nrow(se_rep1)), sep = "_")
```

```{r shinyQC_rep1, eval = FALSE}
MatrixQCvis::shinyQC(se_rep1)
```

```{r shinyQC_prep_rep2}
## rep2
cols <- which(colnames(rep2) == "Col_0_1"):which(colnames(rep2) == "SALK_204674C_3_5")
a <- rep2[, cols] |> as.matrix()
rows_rem <- apply(a, 1, function(x) sum(is.na(x))) > 120
rD <- rep2[, c("mz", "rt", "npeaks", "adduct", "pcgroup")]
a <- a[!rows_rem, ]
rD <- rD[!rows_rem, ]
cD <- data.frame(name = colnames(rep2)[cols])
cD <- dplyr::left_join(cD, weights_rep2, by = c("name" = "genotype"))
cD$genotype <- unlist(lapply(strsplit(cD$name, split = "_"), function(x)
    paste(x[1], x[2], sep = "_")))
cD$batch <- ifelse(cD$number_vial < 66, "1", "2")
se_rep2 <- SummarizedExperiment::SummarizedExperiment(assays = a, rowData = rD, colData = cD)
rownames(se_rep2) <- paste("feature", seq_len(nrow(se_rep2)), sep = "_")
```

```{r shinyQC_rep2, eval = FALSE}
MatrixQCvis::shinyQC(se_rep2)
```

Remove outliers
```{r outlier_neg}
## rep1
outlier <- c("SALK_008908_3_14", "SALK_020876_4_4")
se_rep1 <- MatrixQCvis:::selectSampleSE(se_rep1, selection = outlier, 
    mode = "exclude")
weights_rep1 <- weights_rep1[!weights_rep1$genotype %in% outlier, ]

## rep2 
outlier <- c("SALK_020876_4_4")
se_rep2 <- MatrixQCvis:::selectSampleSE(se_rep2, selection = outlier, 
    mode = "exclude")
weights_rep2 <- weights_rep2[!weights_rep2$genotype %in% outlier, ]
```

```{r transformation_neg, warning = FALSE, message = FALSE}
## divide by weight
assay(se_rep1) <- sweep(assay(se_rep1), MARGIN = 2, STATS = se_rep1$weight, 
    FUN = "/")
assay(se_rep2) <- sweep(assay(se_rep2), MARGIN = 2, STATS = se_rep2$weight, 
    FUN = "/")

## batch correction
se_rep1 <- MatrixQCvis::batchCorrectionAssay(se_rep1, 
    method = "removeBatchEffect (limma)", batchColumn = "batch") |>
    MatrixQCvis:::updateSE(se = se_rep1)
se_rep2 <- batchCorrectionAssay(se_rep2, 
    method = "removeBatchEffect (limma)", batchColumn = "batch") |>
    MatrixQCvis:::updateSE(se = se_rep2)

## take log2 values
se_rep1 <- transformAssay(assay(se_rep1) + 1, method = "log2") |>
    MatrixQCvis:::updateSE(se = se_rep1)
se_rep2 <- transformAssay(assay(se_rep2) + 1, method = "log2") |>
    MatrixQCvis:::updateSE(se = se_rep2)

## impute the NA values
se_rep1 <- imputeAssay(a = assay(se_rep1), method = "MinDet") |>
    MatrixQCvis:::updateSE(se = se_rep1)
se_rep2 <- imputeAssay(a = assay(se_rep2), method = "MinDet") |>
    MatrixQCvis:::updateSE(se = se_rep2)

## create data.frame
rep1 <- cbind(rowData(se_rep1), assay(se_rep1)) |> as.data.frame()
rep2 <- cbind(rowData(se_rep2), assay(se_rep2)) |> as.data.frame()
```

Combine rep1 and rep2
```{r, echo = FALSE}
rt.dev.range <- c(-30, 30)
mz.dev.range <- c(-0.01, 0.01)

res <- vector("list", nrow(rep1))
for (i in 1:nrow(rep1)) {
    mz.diff <- rep2$mz - rep1$mz[i]
    rt.diff <- rep2$rt - rep1$rt[i]
    j <- which(rt.diff > rt.dev.range[1] & rt.diff < rt.dev.range[2] &
                    mz.diff > mz.dev.range[1] & mz.diff < mz.dev.range[2])
    res[[i]] <- if (length(j) == 0) NA else j
}

## obtain values only
rep1_values <- rep1[, which(colnames(rep1) == "Col_0_1"):which(colnames(rep1) == "SALK_204674C_3_5")]
rep2_values <- rep2[, which(colnames(rep2) == "Col_0_1"):which(colnames(rep2) == "SALK_204674C_3_5")]

## convert to matrix
rep1_values <- as.matrix(rep1_values)
mode(rep1_values) <- "numeric"
rep2_values <- as.matrix(rep2_values)
mode(rep2_values) <- "numeric"

## assure that we have the same column names
cols <- intersect(colnames(rep1_values), colnames(rep2_values))
rep1_values <- rep1_values[, cols]
rep2_values <- rep2_values[, cols]

## filter: only take the features that are present in both replicates, for features in rep1 that 
## were mapped multiple times 
## go through res (rows in rep1) and keep the corresponding row in rep2 that has the highest covariance term
## rep1
cor_res <- rep(NaN, length(res))
res_cor <- vector("list", length(res))
for (i in 1:length(res)) {
    inds <- res[[i]]
    if (!all(is.na(inds))) {
        if (length(inds) > 1) {
            cors <- cor(rep1_values[i, ], t(rep2_values[inds, ]))
            cors <- cors[1, ]
        } else {
            cors <- cor(rep1_values[i, ], rep2_values[inds,])
        }
        cor_max <- cors[which.max(cors)]
        cor_res[i] <- cor_max
        res_cor[[i]] <- res[[i]][which.max(cors)]
    } else {
        cor_res[i] <- NaN
        res_cor[[i]] <- NaN
    }
}

res_cor <- unlist(res_cor)
## set features whose features is equal or smaller than 0 to NaN
##res_cor[cov_res <= 0] <- NaN
##cov_res[cov_res <= 0] <- NaN

rep1_cor <- rep1[!is.na(res_cor), ]
rep2_cor <- rep2[res_cor[!is.na(res_cor)], ]

## add the relation of the mapping
rep1_cor <- cbind(rep1_cor, 
    mapping_rep1_rep2 = paste(rownames(rep1_cor), rownames(rep2[res_cor[!is.na(res_cor)], ]), sep = "/"))
rep2_cor <- cbind(rep2_cor, 
    mapping_rep1_rep2 = paste(rownames(rep1[!is.na(res_cor), ]), rownames(rep2_cor), sep = "/"))

## add the correlation with the mapped feature
rep1_cor <- cbind(rep1_cor, cor = cor_res[!is.na(cor_res)])
rep2_cor <- cbind(rep2_cor, cor = cor_res[!is.na(cor_res)])

## add RT deviance 
rep1_cor <- cbind(rep1_cor, rt_dev = rep1_cor[, "rt"] - rep2_cor[, "rt"])
rep2_cor <- cbind(rep2_cor, rt_dev = rep1_cor[, "rt"] - rep2_cor[, "rt"])

## add m/z deviance
rep1_cor <- cbind(rep1_cor, mz_dev = rep1_cor[, "mz"] - rep2_cor[, "mz"])
rep2_cor <- cbind(rep2_cor, mz_dev = rep1_cor[, "mz"] - rep2_cor[, "mz"])


## create function to perform t-test
#' @param features rownames in rep1 to take for performing t-tests
#' @param rep1 containing the values and mapping to rep2 in column mapping_rep1_rep2
#' 
alternative_hypothesis <- function(fit_rep_n, ttest_rep1, features) {
    ### for rep1_neg include the information from the rep1 (one-sided t-test)
    lfc <- 0
    se <- fit_rep_n$stdev.unscaled * sqrt(fit_rep_n$s2.post)
    ## if LFC > 0 (condition 1 > condition 2 for the given contrast): 
    ## (coefficients - lfc) / se
    ## if LFC < 0 (condition 1 < condition 2 for the given contrast): 
    ## (-coefficients - lfc) / se
    coefficients <- ifelse(ttest_rep1[unlist(features), "logFC"] > 0, 
        yes = fit_rep_n$coefficients, no = -fit_rep_n$coefficients)
    tstat <- (coefficients - lfc) / se
    fit_rep_n$t <- array(0, dim(fit_rep_n$coefficients), 
        dimnames = dimnames(fit_rep_n$coefficients))
    fit_rep_n$p.value <- pt(tstat, df = fit_rep_n$df.total, 
        lower.tail = FALSE)
    tstat <- pmax(tstat, 0)
    fit_rep_n$t <- tstat
    fit_rep_n$treat.lfc <- lfc
    tT <- limma::topTable(fit_rep_n, number = Inf, 
        adjust.method = "fdr", p.value = 1)
    rownames(tT) <- names(fit_rep_n$Amean)
    tT
}

perform_ttest <- function(features, rep1, rep2, line) {
    
    ## add _ to line (to circumvent selection of the column of line that shows
    ## number of detected compounds)
    line <- paste(line, "_", sep = "")
    
    ## define the other lines (remove the line itself and the line on the same
    ## gene, if applicable)
    if (line == "SALK_008908_3_")
        other_lines <- c("SALK_011180_5", "SALK_020876_4", "SALK_021216_4", 
            "SALK_024438_5", "SALK_027837_5", "SALK_037430_4", "SALK_049338_4", 
            "SALK_072964_5", "SALK_081021_6", "SALK_201809C_2", 
            "SALK_203337C_2", "SALK_203919C_2", "SALK_204674C_3")
    
    if (line == "SALK_011180_5_")
        other_lines <- c("SALK_008908_3", "SALK_020876_4", "SALK_024438_5", 
            "SALK_027837_5", "SALK_037430_4", "SALK_049338_4", "SALK_072964_5", 
            "SALK_081021_6", "SALK_201809C_2", "SALK_203337C_2", 
            "SALK_203919C_2", "SALK_204674C_3")
    
    if (line == "SALK_020876_4_")   
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_021216_4", 
            "SALK_024438_5", "SALK_037430_4", "SALK_049338_4", "SALK_072964_5", 
            "SALK_201809C_2", "SALK_203337C_2", "SALK_203919C_2",
            "SALK_204674C_3")
    
    if (line == "SALK_021216_4_")
        other_lines <- c("SALK_008908_3", "SALK_020876_4", "SALK_024438_5", 
            "SALK_027837_5", "SALK_037430_4", "SALK_049338_4", "SALK_072964_5", 
            "SALK_081021_6", "SALK_201809C_2", "SALK_203337C_2", 
            "SALK_203919C_2", "SALK_204674C_3")
    
    if (line == "SALK_024438_5_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_020876_4",    
            "SALK_021216_4", "SALK_027837_5", "SALK_037430_4", "SALK_049338_4", 
            "SALK_072964_5", "SALK_081021_6", "SALK_201809C_2",   
            "SALK_203337C_2", "SALK_203919C_2", "SALK_204674C_3")
    
    if (line == "SALK_027837_5_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_021216_4", 
            "SALK_024438_5", "SALK_037430_4", "SALK_049338_4", "SALK_072964_5", 
            "SALK_201809C_2", "SALK_203337C_2", "SALK_203919C_2", 
            "SALK_204674C_3")
    
    if (line == "SALK_037430_4_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_020876_4",    
            "SALK_021216_4", "SALK_024438_5", "SALK_027837_5", "SALK_049338_4", 
            "SALK_072964_5", "SALK_081021_6", "SALK_201809C_2",   
            "SALK_203337C_2", "SALK_203919C_2", "SALK_204674C_3")
    
    if (line == "SALK_049338_4_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_020876_4",    
            "SALK_021216_4", "SALK_024438_5", "SALK_027837_5", "SALK_072964_5", 
            "SALK_081021_6", "SALK_201809C_2", "SALK_203337C_2", 
            "SALK_203919C_2", "SALK_204674C_3")
    
    if (line == "SALK_072964_5_")  
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_020876_4",    
            "SALK_021216_4", "SALK_024438_5", "SALK_027837_5", "SALK_037430_4", 
            "SALK_049338_4", "SALK_081021_6", "SALK_201809C_2",   
            "SALK_203337C_2", "SALK_203919C_2", "SALK_204674C_3")
    
    if (line == "SALK_081021_6_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_021216_4", 
            "SALK_024438_5", "SALK_037430_4", "SALK_049338_4", "SALK_072964_5",
            "SALK_201809C_2", "SALK_203337C_2", "SALK_203919C_2", 
            "SALK_204674C_3")
    
    if (line == "SALK_201809C_2_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_020876_4",    
            "SALK_021216_4", "SALK_024438_5", "SALK_027837_5", "SALK_037430_4", 
            "SALK_049338_4", "SALK_072964_5", "SALK_081021_6", "SALK_204674C_3")
    
    if (line == "SALK_203337C_2_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_020876_4",    
            "SALK_021216_4", "SALK_024438_5", "SALK_027837_5", "SALK_037430_4", 
            "SALK_049338_4", "SALK_072964_5", "SALK_081021_6", "SALK_204674C_3")
    
    if (line == "SALK_203919C_2_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_020876_4",    
            "SALK_021216_4", "SALK_024438_5", "SALK_027837_5", "SALK_037430_4", 
            "SALK_049338_4", "SALK_072964_5", "SALK_081021_6", "SALK_204674C_3")
    
    if (line == "SALK_204674C_3_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_020876_4",    
            "SALK_021216_4", "SALK_024438_5", "SALK_027837_5", "SALK_037430_4", 
            "SALK_049338_4", "SALK_072964_5", "SALK_081021_6", "SALK_201809C_2",   
            "SALK_203337C_2", "SALK_203919C_2")
    
    ## rep1: find corresponding feature in rep2
    features_rep1 <- unlist(features)
    features_rep2 <- rep1[features_rep1, "mapping_rep1_rep2"]
    features_rep2 <- lapply(strsplit(features_rep2, split = "/"), "[", 2) |>
        unlist()
    
    ## retrieve values that contain the intensities
    rep1_values <- rep1[, which(colnames(rep1) == "Col_0_1"):which(colnames(rep1) == "SALK_204674C_3_5")]
    rep2_values <- rep2[, which(colnames(rep2) == "Col_0_1"):which(colnames(rep2) == "SALK_204674C_3_5")]
    
    ## create a model matrix
    ## rep1
    lines_rep1 <- data.frame(lines = character(ncol(rep1_values)))
    lines_rep1[grep(colnames(rep1_values), pattern = "Col_0_"),] <- "Col0"
    lines_rep1[grep(colnames(rep1_values), pattern = line), ] <- "line"
    other_lines_rep1 <- paste(other_lines, "_", sep = "")
    other_lines_rep1 <- paste(other_lines_rep1, collapse = "|")
    lines_rep1[
        grep(colnames(rep1_values), pattern = other_lines_rep1), ] <- "salk"
    modelMatrix_rep1 <- model.matrix(~ lines + 0, lines_rep1)
    
    ## rep2
    lines_rep2 <- data.frame(lines = character(ncol(rep2_values)))
    lines_rep2[grep(colnames(rep2_values), pattern = "Col_0_"), ] <- "Col0"
    lines_rep2[grep(colnames(rep2_values), pattern = line), ] <- "line"
    other_lines_rep2 <- paste(other_lines, "_", sep = "")
    other_lines_rep2 <- paste(other_lines_rep2, collapse = "|")
    lines_rep2[
        grep(colnames(rep2_values), pattern = other_lines_rep2), ] <- "salk"
    modelMatrix_rep2 <- model.matrix(~ lines + 0, lines_rep2)
    
    ## build contrasts
    contrast_rep1_col0 <- limma::makeContrasts("linesCol0-linesline", 
        levels = modelMatrix_rep1)
    contrast_rep1_salk <- limma::makeContrasts("linessalk-linesline", 
        levels = modelMatrix_rep1)
    contrast_rep2_col0 <- limma::makeContrasts("linesCol0-linesline", 
        levels = modelMatrix_rep2)
    contrast_rep2_salk <- limma::makeContrasts("linessalk-linesline", 
        levels = modelMatrix_rep2)
    
    ## perform tests
    fit_rep1 <- limma::lmFit(rep1_values[features_rep1, ], 
        design = modelMatrix_rep1)
    fit_rep2 <- limma::lmFit(rep2_values[features_rep2, ], 
        design = modelMatrix_rep2)
    
    ## for col0
    ## rep1
    fit_rep1_col0 <- limma::contrasts.fit(fit_rep1, contrast_rep1_col0)
    fit_rep1_col0 <- limma::eBayes(fit_rep1_col0, trend = TRUE)
    ttest_rep1_col0 <- limma::topTable(fit_rep1_col0, number = Inf, 
        adjust.method = "fdr", p.value = 1)
    
    ## rep2
    fit_rep2_col0 <- limma::contrasts.fit(fit_rep2, contrast_rep2_col0)
    fit_rep2_col0 <- limma::eBayes(fit_rep2_col0, trend = TRUE)
    
    ### for rep2 include the information from the rep1 (one-sided t-test)
    ttest_rep2_col0 <- limma::topTable(fit_rep2_col0, number = Inf, 
        adjust.method = "fdr", p.value = 1)##alternative_hypothesis(fit_rep_n = fit_rep2_col0, 
        ##ttest_rep1 = ttest_rep1_col0, features = features_rep1)
    
    ## for salk
    ## rep1
    fit_rep1_salk <- limma::contrasts.fit(fit_rep1, contrast_rep1_salk)
    fit_rep1_salk <- limma::eBayes(fit_rep1_salk, trend = TRUE)
    ttest_rep1_salk <- limma::topTable(fit_rep1_salk, number = Inf, 
        adjust.method = "fdr", p.value = 1)
    
    ## rep2
    fit_rep2_salk <- limma::contrasts.fit(fit_rep2, contrast_rep2_salk)
    fit_rep2_salk <- limma::eBayes(fit_rep2_salk, trend = TRUE)
    ttest_rep2_salk <- limma::topTable(fit_rep2_salk, number = Inf, 
        adjust.method = "fdr", p.value = 1)
    ### for rep2 include the information from the rep1 (one-sided t-test)
    ## ttest_rep2_salk <- alternative_hypothesis(fit_rep_n = fit_rep2_salk, 
        ##ttest_rep1 = ttest_rep1_salk, features = features_rep1)

    ## reconcile the results
    cols <- c("rep2", "logFC_rep1", "logFC_rep2", "adj.P.Val_rep1", "adj.P.Val_rep2", 
        "P.Value_rep1", "P.Value_rep2", "AveExpr_rep1", "AveExpr_rep2",
        "t_rep1", "t_rep2", "B_rep1", "B_rep2")
    
    ## col0
    colnames(ttest_rep1_col0) <- paste0(colnames(ttest_rep1_col0), "_rep1")
    colnames(ttest_rep2_col0) <- paste0(colnames(ttest_rep2_col0), "_rep2")
    ttest_col0 <- cbind(rep2 = rownames(ttest_rep2_col0[features_rep2, ]),
        ttest_rep1_col0[features_rep1, ], 
        ttest_rep2_col0[features_rep2, ])
    ttest_col0 <- ttest_col0[, cols]
    
    ## salk
    colnames(ttest_rep1_salk) <- paste0(colnames(ttest_rep1_salk), "_rep1")
    colnames(ttest_rep2_salk) <- paste0(colnames(ttest_rep2_salk), "_rep2")
    ttest_salk <- cbind(rep2 = rownames(ttest_rep2_salk[features_rep2, ]),
        ttest_rep1_salk[features_rep1, ], 
        ttest_rep2_salk[features_rep2, ])
    ttest_salk <- ttest_salk[, cols]
    
    
    ## return the elements
    list(col0 = ttest_col0, salk = ttest_salk)
}
```


### Perform t-tests

```{r, echo = FALSE}
col0 <- c("ttest_Col0", "adj_p_Col0")
salk <- c("ttest_SALK_lines", "adj_p_SALK_lines")
```

For t-tests, `x` is `Col-0` or other SALK lines and `y` is the line.


#### SALK_037430
```{r ttests_neg_SALK_037430, echo = FALSE}
features <- list()

print("## Cluster_30089/Cluster_061967")
print("## 498.1257/8.23")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 498.1259, rt = 8.23)
features[["Cluster_30089/Cluster_061967"]] <- rownames(pl_sel)

print("## Cluster_30089/Cluster_061967")
print("## 498.1257/8.23")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 498.1259, rt = 8.23)
features[["Cluster_30089/Cluster_061967"]] <- rownames(pl_sel)

print("## Cluster_32016/Cluster_067344")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 537.1982, rt = 5.02)
print("## 537.1982/5.02")
print("## 537.1977/5.77")
features[["Cluster_32016/Cluster_067344"]] <- rownames(pl_sel[1:2, ])

print("## Cluster_42555/Cluster_090947")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 728.2757, rt = 4.88) ## n.f.
print("feature not found in repl. 1")

print("## Cluster_42557/Cluster_090947")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 728.2774, rt = 5.04) ## n.f.
print("feature not found in repl. 1")

tt <- perform_ttest(features = features, rep1 = rep1_cor, rep2 = rep2_cor, line = "SALK_037430_4")

## print features
features

print("Col0")
rmarkdown::paged_table(tt[["col0"]])
print("SALK")
rmarkdown::paged_table(tt[["salk"]])
```

#### SALK_072964
```{r, echo = FALSE}
features <- list()

print("## Cluster_26137/Cluster_050014")
pl_sel <- get_metabolite(pl = rep1, mz = 413.1093, rt = 3.57) ## n.f.
print("feature not found in repl. 1")


print("## Cluster_26908/Cluster_052602")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 431.1191, rt = 3.57)
pl_sel <- get_metabolite(pl = rep2_cor, mz = 431.1191, rt = 3.57) ## n.f.
print("feature not found in repl. 2")

print("## Cluster_26909/Cluster_052602")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 431.1194, rt = 3.69)
pl_sel <- get_metabolite(pl = rep2_cor, mz = 431.1194, rt = 3.69)
print("feature not found in repl. 2")

print("## Cluster_28240/Cluster_056944")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 461.1303, rt = 3.85)
print("461.1338/3.43")
#pl_sel <- get_metabolite(pl = rep2_cor, mz = 461.1303, rt = 3.85)
features[["Cluster_28240/Cluster_056944"]] <- rownames(pl_sel)

print("## Cluster_29139/Cluster_059193")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 477.1249, rt = 3.69)
print("feature not found in repl. 1")
# print("477.1186/4.65")
# print("477.1251/2.95")
# features[["Cluster_29139/Cluster_059193"]] <- rownames(pl_sel[1:2, ])

print("## Cluster_30139/Cluster_062059")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 499.1073, rt = 3.69) ## n.f.
print("feature not found in repl. 1")

print("## Cluster_31590/Cluster_066227")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 529.1178, rt = 3.85)
print("529.1177/3.92")
print("## 529.1178/3.69")
features[["Cluster_31590/Cluster_066227"]] <- rownames(pl_sel[1:2, ])


print("## Cluster_31874/Cluster_067055")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 535.1463, rt = 7.12)
print("535.1462/7.82")
print("535.1461/8.03")
features[["Cluster_31874/Cluster_067055"]] <- rownames(pl_sel[1:2, ])


print("## Cluster_31923/Cluster_067181")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 536.1410, rt = 5.01) 
pl_sel <- get_metabolite(pl = rep2_cor, mz = 536.1410, rt = 5.01) ## n.f.
print("feature not found in repl. 1 and repl. 2")

print("## Cluster_32713/Cluster_069229")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 551.1416, rt = 5.90)
print("551.1413/5.94")
features[["Cluster_32713/Cluster_069229"]] <- rownames(pl_sel[1, ])


print("## Cluster_33259/Cluster_070830")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 561.0771, rt = 3.69) ## n.f.
print("feature not found in repl. 1")
pl_sel <- get_metabolite(pl = rep2_cor, mz = 561.0771, rt = 3.69) ## n.f.

print("## Cluster_35713/Cluster_076522")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 603.2200, rt = 6.21)
print("603.2203/6.08")
features[["Cluster_35713/Cluster_076522"]] <- rownames(pl_sel)

print("## Cluster_36010/Cluster_077152")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 608.2201, rt = 2.99)
pl_sel <- get_metabolite(pl = rep2_cor, mz = 608.2201, rt = 2.99) ## n.f.
print("feature not found in repl. 1 and 2")
##features[["Cluster_36010/Cluster_077152"]] <- rownames(pl_sel)


print("## Cluster_39441/Cluster_084545")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 667.1883, rt = 6.86)
print("## 667.1884/7.24")
print("## 667.1889/7.02")
features[["Cluster_39441/Cluster_084545"]] <- rownames(pl_sel[1:2, ])

print("## Cluster_42608/Cluster_091037")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 729.1679, rt = 7.78)
print("729.1683/7.80")
##print("## 729.1680/7.50")
features[["Cluster_42608/Cluster_091037"]] <- rownames(pl_sel[1, ])


print("## Cluster_44863/Cluster_095588")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 777.2247, rt = 6.38)
pl_sel <- get_metabolite(pl = rep2_cor, mz = 777.2247, rt = 6.38) ## n.f.
print("feature not found in repl. 1 and 2")

print("## Cluster_45928/Cluster_097741")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 803.2406, rt = 7.12) ## n.f.
print("feature not found in repl. 1")

print("## Cluster_47541/Cluster_100876")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 845.2356, rt = 4.98)
pl_sel <- get_metabolite(pl = rep2_cor, mz = 845.2356, rt = 4.98) ## n.f.
print("feature not found in repl. 2")


## print features
features

tt <- perform_ttest(features, rep1_cor, rep2_cor, line = "SALK_072964_5")
print("Col0")
rmarkdown::paged_table(tt[["col0"]])
print("SALK")
rmarkdown::paged_table(tt[["salk"]])
```

#### SALK_024438

```{r salk_024438, echo = FALSE}
features <- list()

print("## Cluster_26220/Cluster_050308")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 415.1264, rt = 8.16)
print("## 415.1263/8.21")
features[["Cluster_26220/Cluster_050308"]] <- rownames(pl_sel)

print("## Cluster_29119/Cluster_059172")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 477.0638, rt = 6.33)
print("## 477.0645/6.38")
features[["Cluster_29119/Cluster_059172"]] <- rownames(pl_sel[2, ])

print("## Cluster_35940/Cluster_076981")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 607.0222, rt = 6.33) ## n.f.
print("feature not found in repl. 1")
#pl_sel <- get_metabolite(pl = rep2, mz = 607.0222, rt = 6.33) ## n.f.

print("## Cluster_36285/Cluster_077756")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 613.0401, rt = 6.33)
print("## 613.0398/6.39")
#features[["Cluster_36285/Cluster_077756"]] <- rownames(pl_sel[1, ])
print("feature not found in repl. 1")

print("## Cluster_36917/Cluster_079278")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 625.1013, rt = 4.17) ## n.f.
print("feature not found in repl. 1")


## print features
features

tt <- perform_ttest(features = features, rep1 = rep1_cor, rep2 = rep2_cor, 
    line = "SALK_024438_5")

print("Col0")
rmarkdown::paged_table(tt[["col0"]])
print("SALK")
rmarkdown::paged_table(tt[["salk"]])

```

#### SALK_011180/SALK_021216/SALK_049338


```{r salk_011180_021216_049338, echo = FALSE}
features <- list()

print("## Cluster_27573/Cluster_054996")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 477.0939, rt = 7.42)
print("no feature in repl. 1")
#print("## 477.0872/8.19")
#features[["Cluster_27573/Cluster_054996"]] <- rownames(pl_sel)

print("## Cluster_28337/Cluster_057215")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 463.0882, rt = 6.94)
print("## 463.0885/7.08")
features[["Cluster_28337/Cluster_057215"]] <- rownames(pl_sel[1:2, ])
# 
# pl_sel <- get_metabolite(pl = rep1, mz = 463.0882, rt = 6.94)
# df <- data.frame(values = as.numeric(pl_sel[1, 6:132]), genotype = colnames(pl_sel)[6:132])
# df$genotype <- unlist(lapply(strsplit(df$genotype, split = "_"), function(x) paste(x[1], x[2], sep = "_")))
# ggplot2::ggplot(df, aes(x = genotype, y = values)) + geom_point() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
# 
# pl_sel <- get_metabolite(pl = rep2, mz = 463.0882, rt = 6.94)
# df <- data.frame(values = as.numeric(pl_sel[1, 6:129]), genotype = colnames(pl_sel)[6:129])
# df$genotype <- unlist(lapply(strsplit(df$genotype, split = "_"), function(x) paste(x[1], x[2], sep = "_")))
# ggplot2::ggplot(df, aes(x = genotype, y = values)) + geom_point() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

print("## Cluster_31680/Cluster_066469")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 531.0760, rt = 6.95)
print("531.0761/7.07")
features[["Cluster_31680/Cluster_066469"]] <- rownames(pl_sel[1, ])

print("## Cluster_35169/Cluster_075199")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 593.1515, rt = 6.43)
print("## 593.1516/6.73")
features[["Cluster_35169/Cluster_075199"]] <- rownames(pl_sel[1, ])

# pl_sel <- get_metabolite(pl = rep1, mz = 593.1515, rt = 6.43)
# df <- data.frame(values = as.numeric(pl_sel[2, 6:128]), genotype = colnames(pl_sel)[6:128])
# df$genotype <- unlist(lapply(strsplit(df$genotype, split = "_"), function(x) paste(x[1], x[2], sep = "_")))
# ggplot2::ggplot(df, aes(x = genotype, y = values)) + geom_point() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
# 
# pl_sel <- get_metabolite(pl = rep2, mz = 593.1515, rt = 6.43)
# df <- data.frame(values = as.numeric(pl_sel[1, 6:130]), genotype = colnames(pl_sel)[6:130])
# df$genotype <- unlist(lapply(strsplit(df$genotype, split = "_"), function(x) paste(x[1], x[2], sep = "_")))
# ggplot2::ggplot(df, aes(x = genotype, y = values)) + geom_point() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


print("## Cluster_36050/Cluster_077251")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 609.1464, rt = 6.05)
print("## 609.1466/6.20")
features[["Cluster_36050/Cluster_077251"]] <- rownames(pl_sel[1, ])

print("## Cluster_36813/Cluster_079019")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 623.1617, rt = 6.65)
print("## 623.1625/6.79")
#print("## 623.1621/7.24")
print("## 623.1619/6.15")
features[["Cluster_36813/Cluster_079019"]] <- rownames(pl_sel[c(1, 3), ])

print("## Cluster_36921/Cluster_079272")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 625.1408, rt = 6.27)
print("## 625.1416/6.12")
features[["Cluster_36921/Cluster_079272"]] <- rownames(pl_sel)

print("## Cluster_38140/Cluster_081769")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 645.1232, rt = 6.05)
print("## 645.1229/6.20")
features[["Cluster_38140/Cluster_081769"]] <- rownames(pl_sel[1, ])

print("## Cluster_38744/Cluster_083055")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 655.1520, rt = 6.05)
print("## 655.1519/6.20")
features[["Cluster_38744/Cluster_083055"]] <- rownames(pl_sel[1, ])

print("## Cluster_39122/Cluster_083810")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 661.1390, rt = 6.43)
print("## 661.1390/6.73")
features[["Cluster_39122/Cluster_083810"]] <- rownames(pl_sel)

print("## Cluster_39933/Cluster_085577")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 677.1342, rt = 6.05)
print("## 677.1340/6.19")
features[["Cluster_39933/Cluster_085577"]] <- rownames(pl_sel[2, ])

print("## Cluster_41440/Cluster_088739")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 707.1211, rt = 6.05)
print("## 707.1236/6.19")
features[["Cluster_41440/Cluster_088839"]] <- rownames(pl_sel[2, ])

print("## Cluster_41494/Cluster_088839")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 708.0628, rt = 6.05)
print("708.0637/6.20")
features[["Cluster_41494/Cluster_088839"]] <- rownames(pl_sel)

print("## Cluster_42266/Cluster_090361")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 723.1390, rt = 6.05)
print("## 723.1398/6.19")
features[["Cluster_42266/Cluster_090361"]] <- rownames(pl_sel[1, ])

print("## Cluster_43042/Cluster_091992")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 739.1040, rt = 6.05)
print("## 739.1060/6.19")
features[["Cluster_43042/Cluster_091992"]] <- rownames(pl_sel)

print("## Cluster_43398/Cluster_092629")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 745.1224, rt = 6.05)
print("745.1216/6.20")
features[["Cluster_43398/Cluster_092629"]] <- rownames(pl_sel)

print("## Cluster_44151/Cluster_010308")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 761.0875, rt = 6.05)
print("761.0928/6.19")
features[["Cluster_44151/Cluster_010308"]] <- rownames(pl_sel)

print("## Cluster_46078/Cluster_098040")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 807.0911, rt = 6.05)
print("807.0925/6.19")
features[["Cluster_46078/Cluster_098040"]] <- rownames(pl_sel)

print("## Cluster_46322/Cluster_098526")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 813.1080, rt = 6.05)
print("## 813.1088/6.19")
features[["Cluster_46322/Cluster_098526"]] <- rownames(pl_sel)

print("## Cluster_46959/Cluster_011972")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 829.0748, rt = 6.05)
print("## 829.0803/6.19")
features[["Cluster_46959/Cluster_011972"]] <- rownames(pl_sel)

print("## Cluster_48505/Cluster_102833")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 875.0775, rt = 6.05) ## n.f.
print("feature not found in repl. 1")

print("## Cluster_51012/Cluster_107244")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 958.0279, rt = 6.05)
print("## 958.0318/6.19")
features[["Cluster_51012/Cluster_107244"]] <- rownames(pl_sel)

print("## Cluster_56819/Cluster_114131")
pl_sel <- get_metabolite(pl = rep1_cor, mz = 1219.2990, rt = 6.05)
print("1219.3000/6.20")
features[["Cluster_56819/Cluster_114131"]] <- rownames(pl_sel)

## print features
features

tt <- perform_ttest(features = features, rep1 = rep1_cor, rep2 = rep2_cor, 
    line = "SALK_011180_5")
print("Col0/SALK_011180_5")
rmarkdown::paged_table(tt[["col0"]])
print("SALK/SALK_011180_5")
rmarkdown::paged_table(tt[["salk"]])

tt <- perform_ttest(features = features, rep1 = rep1_cor, rep2 = rep2_cor, 
    line = "SALK_021216_4")
print("Col0/SALK_021216_4")
rmarkdown::paged_table(tt[["col0"]])
print("SALK/SALK_021216_4")
rmarkdown::paged_table(tt[["salk"]])

tt <- perform_ttest(features = features, rep1 = rep1_cor, rep2 = rep2_cor, 
    line = "SALK_049338_4")
print("Col0/SALK_049338_4")
rmarkdown::paged_table(tt[["col0"]])
print("SALK/SALK_049338_4")
rmarkdown::paged_table(tt[["salk"]])
```

### Create plots

```{r plots_negative}
create_plot <- function(feature_rep1 = "feature_16163", 
        feature_rep2 = "feature_13635", line = "SALK_072964") {
    
    #rep1_cor <- rep1_cor[, sort(colnames(rep1_cor))]
    #rep2_cor <- rep2_cor[, sort(colnames(rep2_cor))]
    
    col0 <- c("Col_0_1", "Col_0_2", "Col_0_3", "Col_0_4", "Col_0_5", "Col_0_6",
        "Col_0_7", "Col_0_8", "Col_0_9", "Col_0_10")
    other_salk_lines <- c("mz", "rt", "npeaks", "adduct", "pcgroup", 
        "mapping_rep1_rep2", "cor", "rt_dev", "mz_dev", col0, line)
    salk_rep1 <- !grepl(colnames(rep1_cor), 
        pattern = paste(other_salk_lines, collapse = "|"))
    salk_rep2 <- !grepl(colnames(rep2_cor), 
        pattern = paste(other_salk_lines, collapse = "|"))
    rep1_cor_feat <- rep1_cor[feature_rep1, ]
    rep2_cor_feat <- rep2_cor[feature_rep2, ]
    
    df <- rbind(
        cbind(type = "Col-0", rep = "rep. 1",
            values = as.numeric(rep1_cor_feat[, col0])),
        cbind(type = "SALK", rep = "rep. 1", 
            values = as.numeric(rep1_cor_feat[, salk_rep1])),
        cbind(type = "Col-0", rep = "rep. 2", 
            values = as.numeric(rep2_cor_feat[, col0])),
        cbind(type = "SALK", rep = "rep. 2",
            values = as.numeric(rep2_cor_feat[, salk_rep2]))
    ) |>
        data.frame()
    
    for (i in line) {
        df_i <- rbind(
            cbind(type = i, rep = "rep. 1", values = as.numeric(
                rep1_cor_feat[, grep(colnames(rep1_cor), pattern = i)])),
            cbind(type = i, rep = "rep. 2", values = as.numeric(
                rep2_cor_feat[, grep(colnames(rep2_cor), pattern = i)]))
        )
        df <- rbind(df, df_i)
    }
    df$values <- as.numeric(df$values)
    df$type <- factor(df$type, levels = c("Col-0", "SALK", line))
    
    ## replace rep. 1 and rep. 2 by information on metabolites 
    ## (feature name, mz, rt)
    df$rep[df$rep == "rep. 1"] <- paste(
        feature_rep1, ", rep. 1<br>", "(*m/z* ", round(rep1_cor_feat[, "mz"], 4), 
        ", ", round(rep1_cor_feat[, "rt"] / 60, 2), " min)", sep = "")
    df$rep[df$rep == "rep. 2"] <- paste(
        feature_rep2, ", rep. 2<br>", "(*m/z* ", round(rep2_cor_feat[, "mz"], 4), 
        ", ", round(rep2_cor_feat[, "rt"] / 60, 2), " min)", sep = "")
    df$rep <- factor(df$rep, levels = unique(df$rep))
    
    ## plot
    ggplot(df, aes(x = type, y = values)) +
        geom_boxplot() +
        facet_wrap( ~ rep) +
        xlab("") + ylab("log<sub>2</sub>-normalized intensities") +
        #ggtitle(title_plot) +
        mdthemes::md_theme_bw() +
        mdthemes::as_md_theme(theme(
            axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
            plot.title = element_text(size = 8)))
}

## SALK_024438
create_plot(feature_rep1 = "feature_10432", feature_rep2 = "feature_8310",
            line = "SALK_024438") 
create_plot(feature_rep1 = "feature_13219", feature_rep2 = "feature_10756",
            line = "SALK_024438") 

## SALK_049338
create_plot(feature_rep1 = "feature_12567", feature_rep2 = "feature_10151",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) + ## Col0, SALK
    ggsignif::geom_signif(stat = "identity",
        data = data.frame(x = c(1), xend = c(5), y = c(15.5), annotation = c("***"),
            rep = factor("feature_12567, rep. 1<br>(*m/z* 463.0885, 7.08 min)")),
            aes(x=x, xend=xend, y=y, yend=y, annotation=annotation)) +
    ggsignif::geom_signif(stat = "identity",
        data = data.frame(x = c(2), xend = c(5), y = c(15), annotation = c("***"),
            rep = factor("feature_12567, rep. 1<br>(*m/z* 463.0885, 7.08 min)")),
            aes(x=x, xend=xend, y=y, yend=y, annotation=annotation)) +
    ggsignif::geom_signif(stat = "identity",
        data = data.frame(x = c(1), xend = c(5), y = c(14), annotation = c("***"),
            rep = factor("feature_10151, rep. 2<br>(*m/z* 463.089, 7.01 min)")),
            aes(x=x, xend=xend, y=y, yend=y, annotation=annotation)) +
    ggsignif::geom_signif(stat = "identity",
        data = data.frame(x = c(2), xend = c(5), y = c(13.5), annotation = c("***"),
            rep = factor("feature_10151, rep. 2<br>(*m/z* 463.089, 7.01 min)")),
            aes(x=x, xend=xend, y=y, yend=y, annotation=annotation)) +
        ylim(6, 15.5)


create_plot(feature_rep1 = "feature_15430", feature_rep2 = "feature_12897",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_18293", feature_rep2 = "feature_16038",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) +## Col0, SALK
     ggsignif::geom_signif(stat = "identity",
        data = data.frame(x = c(1), xend = c(5), y = c(21.5), annotation = c("***"),
            rep = factor("feature_18293, rep. 1<br>(*m/z* 609.1466, 6.2 min)")),
            aes(x=x, xend=xend, y=y, yend=y, annotation=annotation)) +
    ggsignif::geom_signif(stat = "identity",
        data = data.frame(x = c(2), xend = c(5), y = c(21.0), annotation = c("***"),
            rep = factor("feature_18293, rep. 1<br>(*m/z* 609.1466, 6.2 min)")),
            aes(x=x, xend=xend, y=y, yend=y, annotation=annotation)) +
    ggsignif::geom_signif(stat = "identity",
        data = data.frame(x = c(1), xend = c(5), y = c(21.5), annotation = c("***"),
            rep = factor("feature_16038, rep. 2<br>(*m/z* 609.1469, 6.15 min)")),
            aes(x=x, xend=xend, y=y, yend=y, annotation=annotation)) +
    ggsignif::geom_signif(stat = "identity",
        data = data.frame(x = c(2), xend = c(5), y = c(21.0), annotation = c("***"),
            rep = factor("feature_16038, rep. 2<br>(*m/z* 609.1469, 6.15 min)")),
            aes(x=x, xend=xend, y=y, yend=y, annotation=annotation)) +
        ylim(12, 22)

create_plot(feature_rep1 = "feature_18802", feature_rep2 = "feature_16608",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_18870", feature_rep2 = "feature_16686",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_19487", feature_rep2 = "feature_17374",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_19787", feature_rep2 = "feature_17722",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_20529", feature_rep2 = "feature_18573",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_21373", feature_rep2 = "feature_19592",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_21398", feature_rep2 = "feature_19634",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_21850", feature_rep2 = "feature_20191",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_22246", feature_rep2 = "feature_20687",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_22396", feature_rep2 = "feature_20876",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_22739", feature_rep2 = "feature_21344",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_23651", feature_rep2 = "feature_22557",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_23748", feature_rep2 = "feature_22688",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_24069", feature_rep2 = "feature_23097",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_26013", feature_rep2 = "feature_25445",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_27333", feature_rep2 = "feature_27062",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK


create_plot(feature_rep1 = "feature_17696", feature_rep2 = "feature_15328",
            line = c("SALK_011180", "SALK_021216", "SALK_049338")) + ## Col0, SALK
    ggsignif::geom_signif(stat = "identity",
        data = data.frame(x = c(1), xend = c(5), y = c(21.5), annotation = c("*"),
            rep = factor("feature_17696, rep. 1<br>(*m/z* 593.1516, 6.73 min)")),
            aes(x=x, xend=xend, y=y, yend=y, annotation=annotation)) +
        ylim(19, 22)

```


## Positive mode

### Load and prepare the data 
```{r load_positive, echo = FALSE}
weights_rep1 <- weights_rep1_old
weights_rep2 <- weights_rep2_old
################################################################################
################################# positive mode ################################
################################################################################
## rep1
rep1 <- read.table("TDNA_rep1/pos/TDNA_replicate1_pos_peaklist.txt", 
    header = TRUE, sep = "\t")
colnames(rep1) <- gsub(colnames(rep1), pattern = "_pos", replacement = "")
colnames(rep1) <- gsub(colnames(rep1), pattern = "Col0", replacement = "Col_0")
colnames(rep1) <- gsub(colnames(rep1), pattern = "SALK_204674", replacement = "SALK_204674C")
rep1[rep1 == 0] <- NA

################################################################################
################################# negative mode ################################
################################################################################
## since there is no second replicate for the positive mode, the features
## will be linked to the corresponding features in negative mode
## rep1_neg
rep1_neg <- read.table("TDNA_rep1/neg/TDNA_replicate1_neg_peaklist.txt", 
    header = TRUE, sep = "\t")
colnames(rep1_neg) <- gsub(colnames(rep1_neg), pattern = "_neg", replacement = "")
rep1_neg[rep1_neg == 0] <- NA

## rep2_neg
rep2_neg <- read.table("TDNA_rep2/neg/raw_number_vial/TDNA_replicate2_neg_peaklist.txt", 
    header = TRUE, sep = "\t")
colnames(rep2_neg) <- gsub(colnames(rep2_neg), pattern = "_neg", replacement = "")
rep2_neg[rep2_neg == 0] <- NA
```

Check data quality with `shinyQC`.
```{r shinyQC_prep_rep1_pos, echo = FALSE}
## rep1
cols <- which(colnames(rep1) == "Col_0_1"):which(colnames(rep1) == "SALK_204674C_3_5")
a <- rep1[, cols] |> as.matrix()
rows_rem <- apply(a, 1, function(x) sum(is.na(x))) > 120
rD <- rep1[, c("mz", "rt", "npeaks", "adduct", "pcgroup")]
a <- a[!rows_rem, ]
rD <- rD[!rows_rem, ]
cD <- data.frame(name = colnames(rep1)[cols])
cD <- dplyr::left_join(cD, weights_rep1, by = c("name" = "genotype"))
cD$batch <- ifelse(cD$injection_vial < 60, "1", "2")
cD$genotype <- gsub(x = cD$name, pattern = "_[0-9][0-9]$|_[0-9]$", replacement = "")
se_rep1 <- SummarizedExperiment::SummarizedExperiment(assays = a, rowData = rD, colData = cD)
rownames(se_rep1) <- paste("feature", seq_len(nrow(se_rep1)), sep = "_")
```

```{r shinyQC_rep1_pos, eval = FALSE, echo = FALSE}
MatrixQCvis::shinyQC(se_rep1)
```

```{r shinyQC_prep_rep1_neg, echo = FALSE}
## rep1_neg
cols <- which(colnames(rep1_neg) == "Col_0_1"):which(colnames(rep1_neg) == "SALK_204674C_3_5")
a <- rep1_neg[, cols] |> as.matrix()
rows_rem <- apply(a, 1, function(x) sum(is.na(x))) > 110
rD <- rep1_neg[, c("mz", "rt", "npeaks", "adduct", "pcgroup")]
a <- a[!rows_rem, ]
rD <- rD[!rows_rem, ]
cD <- data.frame(name = colnames(rep1_neg)[cols])
cD <- dplyr::left_join(cD, weights_rep1, by = c("name" = "genotype"))
cD$batch <- ifelse(cD$injection_vial < 60, "1", "2")
cD$genotype <- gsub(x = cD$name, pattern = "_[0-9][0-9]$|_[0-9]$", replacement = "")
se_rep1_neg <- SummarizedExperiment::SummarizedExperiment(assays = a, rowData = rD, colData = cD)
rownames(se_rep1_neg) <- paste("feature", seq_len(nrow(se_rep1_neg)), sep = "_")
```

```{r shinyQC_rep1_pos_neg, eval = FALSE}
MatrixQCvis::shinyQC(se_rep1_neg)
```

```{r shinyQC_prep_rep2_neg, echo = FALSE}
## rep2_neg
cols <- which(colnames(rep2_neg) == "Col_0_1"):which(colnames(rep2_neg) == "SALK_204674C_3_5")
a <- rep2_neg[, cols] |> as.matrix()
rows_rem <- apply(a, 1, function(x) sum(is.na(x))) > 120
rD <- rep2_neg[, c("mz", "rt", "npeaks", "adduct", "pcgroup")]
a <- a[!rows_rem, ]
rD <- rD[!rows_rem, ]
cD <- data.frame(name = colnames(rep2_neg)[cols])
cD <- dplyr::left_join(cD, weights_rep2, by = c("name" = "genotype"))
cD$batch <- ifelse(cD$number_vial < 66, "1", "2")
cD$genotype <- gsub(x = cD$name, pattern = "_[0-9][0-9]$|_[0-9]$", replacement = "")
se_rep2_neg <- SummarizedExperiment::SummarizedExperiment(assays = a, rowData = rD, colData = cD)
rownames(se_rep2_neg) <- paste("feature", seq_len(nrow(se_rep2_neg)), sep = "_")
```

```{r shinyQC_rep2_neg_pos, eval = FALSE}
MatrixQCvis::shinyQC(se_rep2_neg)
```

Remove outliers
```{r outlier_pos, echo = FALSE}
## rep1
outlier <- c("SALK_011180_5_3", "SALK_072964_5_4", "SALK_203337C_2_2",
    "SALK_049338_4_3", "SALK_008908_3_14", "SALK_008908_3_12")
se_rep1 <- MatrixQCvis:::selectSampleSE(se_rep1, selection = outlier,
    mode = "exclude")

## rep1_neg
outlier <- c("SALK_008908_3_14", "SALK_020876_4_4")
se_rep1_neg <- MatrixQCvis:::selectSampleSE(se_rep1_neg, selection = outlier, 
    mode = "exclude")

## rep2_neg
outlier <- c("SALK_020876_4_4")
se_rep2_neg <- MatrixQCvis:::selectSampleSE(se_rep2_neg, selection = outlier, 
    mode = "exclude")
```

```{r transformation_pos, warning = FALSE, message = FALSE, echo = FALSE}
## divide by weight
assay(se_rep1) <- sweep(assay(se_rep1), MARGIN = 2, STATS = se_rep1$weight, 
    FUN = "/")
assay(se_rep1_neg) <- sweep(assay(se_rep1_neg), MARGIN = 2, 
    STATS = se_rep1_neg$weight, FUN = "/")
assay(se_rep2_neg) <- sweep(assay(se_rep2_neg), MARGIN = 2,  
    STATS = se_rep2_neg$weight, FUN = "/")

## batch correction
se_rep1 <- MatrixQCvis::batchCorrectionAssay(se_rep1, 
    method = "removeBatchEffect (limma)", batchColumn = "batch") |>
    MatrixQCvis:::updateSE(se = se_rep1)
se_rep1_neg <- batchCorrectionAssay(se_rep1_neg, 
    method = "removeBatchEffect (limma)", batchColumn = "batch") |>
    MatrixQCvis:::updateSE(se = se_rep1_neg)
se_rep2_neg <- batchCorrectionAssay(se_rep2_neg, 
    method = "removeBatchEffect (limma)", batchColumn = "batch") |>
    MatrixQCvis:::updateSE(se = se_rep2_neg)

## take log2 values
se_rep1 <- transformAssay(assay(se_rep1) + 1, method = "log2") |>
    MatrixQCvis:::updateSE(se = se_rep1)
se_rep1_neg <- transformAssay(assay(se_rep1_neg) + 1, method = "log2") |>
    MatrixQCvis:::updateSE(se = se_rep1_neg)
se_rep2_neg <- transformAssay(assay(se_rep2_neg) + 1, method = "log2") |>
    MatrixQCvis:::updateSE(se = se_rep2_neg)

## impute the NA values
se_rep1 <- imputeAssay(a = assay(se_rep1), method = "MinDet") |>
    MatrixQCvis:::updateSE(se = se_rep1)
se_rep1_neg <- imputeAssay(a = assay(se_rep1_neg), method = "MinDet") |>
    MatrixQCvis:::updateSE(se = se_rep1_neg)
se_rep2_neg <- imputeAssay(a = assay(se_rep2_neg), method = "MinDet") |>
    MatrixQCvis:::updateSE(se = se_rep2_neg)

## create data.frame
rep1 <- cbind(rowData(se_rep1), assay(se_rep1)) |> as.data.frame()
rep1_neg <- cbind(rowData(se_rep1_neg), assay(se_rep1_neg)) |> as.data.frame()
rep2_neg <- cbind(rowData(se_rep2_neg), assay(se_rep2_neg)) |> as.data.frame()
```

Combine rep1, rep1_neg and rep2_neg. 

Link `rep1` to `rep1_neg` and `rep2_neg` using the correlation and rt 
deviation.

```{r, echo = FALSE}
rt.dev.range <- c(-0.01, 0.01)
rt.dev.range <- c(-30, 30)
match_seed1 <- read.csv("match_seed1.csv")
match_seed2 <- read.csv("match_seed2.csv")

## create function to perform t-test
#' @param features rownames in rep1 to take for performing t-tests
#' @param rep1 containing the values and mapping to rep2 in column mapping_rep1_rep2
perform_ttest <- function(features, rep1, rep1_neg, rep2_neg, line) {
    
    ## add _ to line (to circumvent selection of the column of line that shows
    ## number of detected compounds)
    line <- paste(line, "_", sep = "")
    
    ## define the other lines (remove the line itself and the line on the same
    ## gene, if applicable)
    if (line == "SALK_008908_3_")
        other_lines <- c("SALK_011180_5", "SALK_020876_4", "SALK_021216_4", 
            "SALK_024438_5", "SALK_027837_5", "SALK_037430_4", "SALK_049338_4", 
            "SALK_072964_5", "SALK_081021_6", "SALK_201809C_2", 
            "SALK_203337C_2", "SALK_203919C_2", "SALK_204674C_3")
    
    if (line == "SALK_011180_5_")
        other_lines <- c("SALK_008908_3", "SALK_020876_4", "SALK_024438_5", 
            "SALK_027837_5", "SALK_037430_4", "SALK_049338_4", "SALK_072964_5", 
            "SALK_081021_6", "SALK_201809C_2", "SALK_203337C_2", 
            "SALK_203919C_2", "SALK_204674C_3")
    
    if (line == "SALK_020876_4_")   
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_021216_4", 
            "SALK_024438_5", "SALK_037430_4", "SALK_049338_4", "SALK_072964_5", 
            "SALK_201809C_2", "SALK_203337C_2", "SALK_203919C_2",
            "SALK_204674C_3")
    
    if (line == "SALK_021216_4_")
        other_lines <- c("SALK_008908_3", "SALK_020876_4", "SALK_024438_5", 
            "SALK_027837_5", "SALK_037430_4", "SALK_049338_4", "SALK_072964_5", 
            "SALK_081021_6", "SALK_201809C_2", "SALK_203337C_2", 
            "SALK_203919C_2", "SALK_204674C_3")
    
    if (line == "SALK_024438_5_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_020876_4",    
            "SALK_021216_4", "SALK_027837_5", "SALK_037430_4", "SALK_049338_4", 
            "SALK_072964_5", "SALK_081021_6", "SALK_201809C_2",   
            "SALK_203337C_2", "SALK_203919C_2", "SALK_204674C_3")
    
    if (line == "SALK_027837_5_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_021216_4", 
            "SALK_024438_5", "SALK_037430_4", "SALK_049338_4", "SALK_072964_5", 
            "SALK_201809C_2", "SALK_203337C_2", "SALK_203919C_2", 
            "SALK_204674C_3")
    
    if (line == "SALK_037430_4_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_020876_4",    
            "SALK_021216_4", "SALK_024438_5", "SALK_027837_5", "SALK_049338_4", 
            "SALK_072964_5", "SALK_081021_6", "SALK_201809C_2",   
            "SALK_203337C_2", "SALK_203919C_2", "SALK_204674C_3")
    
    if (line == "SALK_049338_4_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_020876_4",    
            "SALK_021216_4", "SALK_024438_5", "SALK_027837_5", "SALK_072964_5", 
            "SALK_081021_6", "SALK_201809C_2", "SALK_203337C_2", 
            "SALK_203919C_2", "SALK_204674C_3")
    
    if (line == "SALK_072964_5_")  
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_020876_4",    
            "SALK_021216_4", "SALK_024438_5", "SALK_027837_5", "SALK_037430_4", 
            "SALK_049338_4", "SALK_081021_6", "SALK_201809C_2",   
            "SALK_203337C_2", "SALK_203919C_2", "SALK_204674C_3")
    
    if (line == "SALK_081021_6_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_021216_4", 
            "SALK_024438_5", "SALK_037430_4", "SALK_049338_4", "SALK_072964_5",
            "SALK_201809C_2", "SALK_203337C_2", "SALK_203919C_2", 
            "SALK_204674C_3")
    
    if (line == "SALK_201809C_2_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_020876_4",    
            "SALK_021216_4", "SALK_024438_5", "SALK_027837_5", "SALK_037430_4", 
            "SALK_049338_4", "SALK_072964_5", "SALK_081021_6", "SALK_204674C_3")
    
    if (line == "SALK_203337C_2_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_020876_4",    
            "SALK_021216_4", "SALK_024438_5", "SALK_027837_5", "SALK_037430_4", 
            "SALK_049338_4", "SALK_072964_5", "SALK_081021_6", "SALK_204674C_3")
    
    if (line == "SALK_203919C_2_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_020876_4",    
            "SALK_021216_4", "SALK_024438_5", "SALK_027837_5", "SALK_037430_4", 
            "SALK_049338_4", "SALK_072964_5", "SALK_081021_6", "SALK_204674C_3")
    
    if (line == "SALK_204674C_3_")
        other_lines <- c("SALK_008908_3", "SALK_011180_5", "SALK_020876_4",    
            "SALK_021216_4", "SALK_024438_5", "SALK_027837_5", "SALK_037430_4", 
            "SALK_049338_4", "SALK_072964_5", "SALK_081021_6", "SALK_201809C_2",   
            "SALK_203337C_2", "SALK_203919C_2")
    
    ## find corresponding features in rep1_neg and rep2_neg
    features_rep1 <- lapply(strsplit(names(features), split = "/"), "[", 1) |>
        unlist()
    features_rep2 <- lapply(strsplit(names(features), split = "/"), "[", 2) |>
        unlist()
    
    ## iterate through cluster features and find corresponding features in
    ## rep1_neg and rep2_neg
    cols <- c("names_neg", "neg_mz", "neg_rt")
    res_rep1_neg <- as.list(rep(NA, length(features_rep1)))
    res_rep2_neg <- as.list(rep(NA, length(features_rep1)))
    mz.dev.range <- c(-0.01, 0.01)
    rt.dev.range <- c(-30, 30)
    
    for (i in seq_along(features_rep1)) {
        features_neg <- rbind(
            match_seed1[match_seed1$names_pos == features_rep1[i], cols],
            match_seed2[match_seed2$names_pos == features_rep2[i], cols]
        )
        ## iterate through features_neg and find the features in rep1_neg
        ## and reg2_neg with the smallest deviation
        for (j in seq_along(nrow(features_neg))) {
            ## rep1_neg
            rt.diff <- rep1_neg$rt - features_neg$neg_rt[j] * 60
            mz.diff <- rep1_neg$mz - features_neg$neg_mz[j]
            inds <- which(rt.diff > rt.dev.range[1] & rt.diff < rt.dev.range[2] & 
                mz.diff > mz.dev.range[1] & mz.diff < mz.dev.range[2])
            res_rep1_neg[[i]] <- c(res_rep1_neg[[i]], inds)
    
            ## rep2_neg
            rt.diff <- rep2_neg$rt - features_neg$neg_rt[j] * 60
            mz.diff <- rep2_neg$mz - features_neg$neg_mz[j]
            inds <- which(rt.diff > rt.dev.range[1] & rt.diff < rt.dev.range[2] &
                mz.diff > mz.dev.range[1] & mz.diff < mz.dev.range[2])
            res_rep2_neg[[i]] <- c(res_rep2_neg[[i]], inds)
        }
    }
    
    ## retrieve values that contain the intensities
    rep1_values <- rep1[, which(colnames(rep1) == "Col_0_1"):which(colnames(rep1) == "SALK_204674C_3_5")]
    rep1_neg_values <- rep1_neg[, which(colnames(rep1_neg) == "Col_0_1"):which(colnames(rep1_neg) == "SALK_204674C_3_5")]
    rep2_neg_values <- rep2_neg[, which(colnames(rep2_neg) == "Col_0_1"):which(colnames(rep2_neg) == "SALK_204674C_3_5")]

    ## convert to matrix
    rep1_values <- as.matrix(rep1_values)
    mode(rep1_values) <- "numeric"
    rep1_neg_values <- as.matrix(rep1_neg_values)
    mode(rep1_neg_values) <- "numeric"
    rep2_neg_values <- as.matrix(rep2_neg_values)
    mode(rep2_neg_values) <- "numeric"

    ## assure that we have the same column names
    cols <- intersect(colnames(rep1_values), colnames(rep1_neg_values))
    cols <- intersect(cols, colnames(rep2_neg_values))
    rep1_values <- rep1_values[, cols]
    rep1_neg_values <- rep1_neg_values[, cols]
    rep2_neg_values <- rep2_neg_values[, cols]

    ## filter: only take the features that are present in both replicates, for 
    ## features in rep1 that were mapped multiple times 
    ## go through res (rows in rep1) and keep the corresponding row in rep1_neg 
    ## that has the highest correlation term
    ## rep1_neg
    res_cor_rep1_neg <- vector("list", length(res_rep1_neg))
    for (i in 1:length(res_rep1_neg)) {
        inds <- res_rep1_neg[[i]]
        if (!all(is.na(inds))) {
            if (length(inds) > 1) {
                cors <- cor(rep1_values[features[[i]], ], t(rep1_neg_values[inds, ]))
            } else {
                cors <- cor(rep1_values[features[[i]], ], rep1_neg_values[inds,])
            }
            cor_max <- cors[which.max(cors)]
            res_cor_rep1_neg[[i]] <- res_rep1_neg[[i]][which.max(cors)]
        } else {
            res_cor_rep1_neg[[i]] <- NA
        }
    }
    res_cor_rep1_neg <- unlist(res_cor_rep1_neg)

    ## rep2_neg
    res_cor_rep2_neg <- vector("list", length(res_rep2_neg))
    for (i in 1:length(res_rep2_neg)) {
        inds <- res_rep2_neg[[i]]
        if (!all(is.na(inds))) {
            if (length(inds) > 1) {
                cors <- cor(rep1_values[features[[i]], ], t(rep2_neg_values[inds, ]))
                cors <- cors[1, ]
            } else {
                cors <- cor(rep1_values[features[[i]], ], rep2_neg_values[inds,])
            }
            res_cor_rep2_neg[[i]] <- res_rep2_neg[[i]][which.max(cors)]
        } else {
            res_cor_rep2_neg[[i]] <- NA
        }
    }
    res_cor_rep2_neg <- unlist(res_cor_rep2_neg)

    ## create a model matrix
    ## for rep1, rep1_neg and rep2_neg all same since we ordered the columns
    ## in the same way in step "assure that we have the same column names"
    lines_rep1 <- data.frame(lines = character(ncol(rep1_values)))
    lines_rep1[grep(colnames(rep1_values), pattern = "Col_0_"),] <- "Col0"
    lines_rep1[grep(colnames(rep1_values), pattern = line), ] <- "line"
    other_lines_rep1 <- paste(other_lines, "_", sep = "")
    other_lines_rep1 <- paste(other_lines_rep1, collapse = "|")
    lines_rep1[
        grep(colnames(rep1_values), pattern = other_lines_rep1), ] <- "salk"
    modelMatrix_rep1 <- model.matrix(~ lines + 0, lines_rep1)
    modelMatrix_rep1_neg <- modelMatrix_rep2_neg <- modelMatrix_rep1
    
    ## build contrasts
    contrast_rep1_col0 <- limma::makeContrasts("linesCol0-linesline", 
        levels = modelMatrix_rep1)
    contrast_rep1_salk <- limma::makeContrasts("linessalk-linesline", 
        levels = modelMatrix_rep1)
    contrast_rep1_neg_col0 <- contrast_rep2_neg_col0 <- contrast_rep1_col0
    contrast_rep1_neg_salk <- contrast_rep2_neg_salk <- contrast_rep1_salk
    
    ## create a mapping table that will be used to reconcile the results
    rep1_neg_values <- rep1_neg_values[res_cor_rep1_neg, ]
    rep2_neg_values <- rep2_neg_values[res_cor_rep2_neg, ]
    rownames(rep1_neg_values)[!is.na(rownames(rep1_neg_values))] <- paste(
        rownames(rep1_neg_values)[!is.na(rownames(rep1_neg_values))],
        seq_along(rownames(rep1_neg_values)[!is.na(rownames(rep1_neg_values))]),
        sep = "_")
    rownames(rep2_neg_values)[!is.na(rownames(rep2_neg_values))] <- paste(
        rownames(rep2_neg_values)[!is.na(rownames(rep2_neg_values))],
        seq_along(rownames(rep2_neg_values)[!is.na(rownames(rep2_neg_values))]),
        sep = "_")
    mappings <- data.frame(
        rep1 = rownames(rep1_values[unlist(features),]),
        rep1_neg = rownames(rep1_neg_values),
        rep2_neg = rownames(rep2_neg_values)    
    )
    
    ## perform tests
    fit_rep1 <- limma::lmFit(rep1_values[unlist(features), ], 
        design = modelMatrix_rep1)
    fit_rep1_neg <- limma::lmFit(
        rep1_neg_values[!is.na(res_cor_rep1_neg), , drop = FALSE], 
        design = modelMatrix_rep1_neg)
    fit_rep2_neg <- limma::lmFit(
        rep2_neg_values[!is.na(res_cor_rep2_neg), , drop = FALSE], 
        design = modelMatrix_rep2_neg)
    
    ## for col0
    ## rep1
    fit_rep1_col0 <- limma::contrasts.fit(fit_rep1, contrast_rep1_col0)
    fit_rep1_col0 <- limma::eBayes(fit_rep1_col0, trend = TRUE)
    ttest_rep1_col0 <- limma::topTable(fit_rep1_col0, number = Inf, 
        adjust.method = "fdr", p.value = 1)
    
    ## rep1_neg (include the information from the rep1 (one-sided t-test))
    fit_rep1_neg_col0 <- limma::contrasts.fit(fit_rep1_neg, contrast_rep1_neg_col0)
    fit_rep1_neg_col0 <- limma::eBayes(fit_rep1_neg_col0, trend = TRUE)
    ttest_rep1_neg_col0 <- limma::topTable(fit_rep1_neg_col0, number = Inf, 
        adjust.method = "fdr", p.value = 1)##alternative_hypothesis(
        ##fit_rep_n = fit_rep1_neg_col0, ttest_rep1 = ttest_rep1_col0,
        ##features = features[!is.na(res_cor_rep1_neg)])
    
    ## rep2_neg (include the information from the rep1 (one-sided t-test))
    fit_rep2_neg_col0 <- limma::contrasts.fit(fit_rep2_neg, contrast_rep2_neg_col0)
    fit_rep2_neg_col0 <- limma::eBayes(fit_rep2_neg_col0, trend = TRUE)
    ttest_rep2_neg_col0 <- limma::topTable(fit_rep2_neg_col0, number = Inf, 
        adjust.method = "fdr", p.value = 1)##alternative_hypothesis(
        ##fit_rep_n = fit_rep2_neg_col0, ttest_rep1 = ttest_rep1_col0,
        ##features = features[!is.na(res_cor_rep2_neg)])

    ## for salk
    ## rep1
    fit_rep1_salk <- limma::contrasts.fit(fit_rep1, contrast_rep1_salk)
    fit_rep1_salk <- limma::eBayes(fit_rep1_salk, trend = TRUE)
    ttest_rep1_salk <- limma::topTable(fit_rep1_salk, number = Inf, 
        adjust.method = "fdr", p.value = 1)
    
    ## rep1_neg (include the information from the rep1 (one-sided t-test))
    fit_rep1_neg_salk <- limma::contrasts.fit(fit_rep1_neg, contrast_rep1_neg_salk)
    fit_rep1_neg_salk <- limma::eBayes(fit_rep1_neg_salk, trend = TRUE)
    ttest_rep1_neg_salk <- limma::topTable(fit_rep1_neg_salk, number = Inf, 
        adjust.method = "fdr", p.value = 1)
        #alternative_hypothesis(
        #fit_rep_n = fit_rep1_neg_salk, ttest_rep1 = ttest_rep1_salk,
        #features = features[!is.na(res_cor_rep1_neg)])
    
    ## rep2_neg (include the information from the rep1 (one-sided t-test))
    fit_rep2_neg_salk <- limma::contrasts.fit(fit_rep2_neg, contrast_rep2_neg_salk)
    fit_rep2_neg_salk <- limma::eBayes(fit_rep2_neg_salk, trend = TRUE)
    ttest_rep2_neg_salk <- limma::topTable(fit_rep2_neg_salk, number = Inf, 
        adjust.method = "fdr", p.value = 1)
        # 
        # alternative_hypothesis(###################################
        # fit_rep_n = fit_rep2_neg_salk, ttest_rep1 = ttest_rep1_salk,
        # features = unlist(features)[!is.na(res_cor_rep2_neg)])
    
    ## reconcile the results
    cols <- c("rep1_neg", "rep2_neg", "logFC_rep1", "logFC_rep1_neg", "logFC_rep2_neg",
        "adj.P.Val_rep1", "adj.P.Val_rep1_neg", "adj.P.Val_rep2_neg", 
        "P.Value_rep1", "P.Value_rep1_neg", "P.Value_rep2_neg",
        "AveExpr_rep1", "AveExpr_rep1_neg", "AveExpr_rep2_neg",
        "t_rep1", "t_rep1_neg", "t_rep2_neg", 
        "B_rep1", "B_rep1_neg", "B_rep2_neg")
    
    ## col0
    colnames(ttest_rep1_col0) <- paste0(colnames(ttest_rep1_col0), "_rep1")
    colnames(ttest_rep1_neg_col0) <- paste0(colnames(ttest_rep1_neg_col0), "_rep1_neg")
    colnames(ttest_rep2_neg_col0) <- paste0(colnames(ttest_rep2_neg_col0), "_rep2_neg")
    ttest_col0 <- cbind(rep1 = rownames(ttest_rep1_col0), ttest_rep1_col0)
    ttest_col0 <- dplyr::left_join(ttest_col0, mappings, by = c("rep1" = "rep1"))
    ttest_col0 <- dplyr::left_join(ttest_col0, 
        cbind(rep1_neg = rownames(ttest_rep1_neg_col0), ttest_rep1_neg_col0),
        by = "rep1_neg")
    ttest_col0 <- dplyr::left_join(ttest_col0,
        cbind(rep2_neg = rownames(ttest_rep2_neg_col0), ttest_rep2_neg_col0),
        by = "rep2_neg")
    ttest_col0 <- ttest_col0[, cols]
    rownames(ttest_col0) <- rownames(ttest_rep1_col0)
    ttest_col0 <- ttest_col0[unlist(features), ]
    
    ## salk
    colnames(ttest_rep1_salk) <- paste0(colnames(ttest_rep1_salk), "_rep1")
    colnames(ttest_rep1_neg_salk) <- paste0(colnames(ttest_rep1_neg_salk), "_rep1_neg")
    colnames(ttest_rep2_neg_salk) <- paste0(colnames(ttest_rep2_neg_salk), "_rep2_neg")
    ttest_salk <- cbind(rep1 = rownames(ttest_rep1_salk), ttest_rep1_salk)
    ttest_salk <- dplyr::left_join(ttest_salk, mappings, by = "rep1")
    ttest_salk <- dplyr::left_join(ttest_salk, 
        cbind(rep1_neg = rownames(ttest_rep1_neg_salk), ttest_rep1_neg_salk),
        by = "rep1_neg")
    ttest_salk <- dplyr::left_join(ttest_salk,
        cbind(rep2_neg = rownames(ttest_rep2_neg_salk), ttest_rep2_neg_salk),
        by = "rep2_neg")
    ttest_salk <- ttest_salk[, cols]
    rownames(ttest_salk) <- rownames(ttest_rep1_salk)
    ttest_salk <- ttest_salk[unlist(features), ]
    
    
    ## return the elements
    list(col0 = ttest_col0, salk = ttest_salk)
}
```


### Perform t-tests

Unfortunately, we have no backup of these samples to run the samples in
positive mode (= second replicate).

Leonardo used the existing data to find equivalences in the negative dataset 
when they existed. Leonardo created lists with the negative clusters that 
exhibit high correlation within the positive clusters in the same retention 
times. Some of them are clearly the same compound judging from the differences 
in masses. Leonardo did this for both the seed1 and seed2 datasets, as well as 
combining both and selecting only those that were consistent. The latter, 
should be the most reliable to test for differences (at least 39 unique ions).

Replicate 2 is missing for SALK lines in positive mode. Correlate the 
negative and positive and find corresponding features in negative mode.

If there is a match in the negative mode, find the feature with highest 
correlation values in the negative mode (either from repl. 1 or repl. 2) 
and perform a t-test on this feature in the data set of repl. 1 or repl. 2.



```{r, echo = FALSE}
col0 <- c("ttest_Col0", "adj_p_Col0")
salk <- c("ttest_SALK_lines", "adj_p_SALK_lines")
```

#### SALK_008908
```{r ttests_pos_SALK_008908, echo = FALSE}
features <- list()

print("## Cluster_38138/Cluster_081955")
pl_sel <- get_metabolite(pl = rep1, mz = 239.0889, rt = 6.24)
print("## 239.0889/6.24")
print("no corresponding feature in rep1_neg and rep2_neg")
#features[["Cluster_38138/Cluster_081955"]] <- rownames(pl_sel[2, ])


print("## Cluster_40845/Cluster_086976")
pl_sel <- get_metabolite(pl = rep1, mz = 265.1068, rt = 7.36)
print("265.1068/7.35")
features[["Cluster_40845/Cluster_086976"]] <- rownames(pl_sel)


print("## Cluster_42914/Cluster_090910")
pl_sel <- get_metabolite(pl = rep1, mz = 284.1486, rt = 5.05)
print("284.1491/4.54")
print("no corresponding feature in rep1_neg and rep2_neg")
#features[["Cluster_42914/Cluster_090910"]] <- rownames(pl_sel[1, ])

print("## Cluster_46305/Cluster_099304")
pl_sel <- get_metabolite(pl = rep1, mz = 324.1805, rt = 7.36)
print("324.1805/7.36")
features[["Cluster_46305/Cluster_099304"]] <- rownames(pl_sel[1, ])

## print features
features

tt <- perform_ttest(features = features, rep1 = rep1, rep1_neg = rep1_neg, 
    rep2_neg = rep2_neg, line = "SALK_008908_3")
print("Col0")
rmarkdown::paged_table(tt[["col0"]])
print("SALK")
rmarkdown::paged_table(tt[["salk"]])
```


#### SALK_037430/SALK_020876/SALK_027837/SALK_081021

```{r ttests_pos_SALK_037430_SALK_020876_SALK_027837_SALK_081021, echo=FALSE}
features <- list()

print("## Cluster_12529/Cluster_031642")
pl_sel <- get_metabolite(pl = rep1, mz = 397.0430, rt = 0.73)
print("397.0430/0.72")
features[["Cluster_12529/Cluster_031642"]] <- rownames(pl_sel[1, ])

print("## Cluster_42473/Cluster_090187")
pl_sel <- get_metabolite(pl = rep1, mz = 280.1539, rt = 4.87)
print("280.1543/5.36")
print("no corresponding feature in rep1_neg and rep2_neg")
#features[["Cluster_42473/Cluster_090187"]] <- rownames(pl_sel[2, ])

print("## Cluster_55389/Cluster_121272")
pl_sel <- get_metabolite(pl = rep1, mz = 437.1441, rt = 6.98)
print("437.1441/6.98")
features[["Cluster_55389/Cluster_121272"]] <- rownames(pl_sel)

print("## Cluster_59049/Cluster_129762")
pl_sel <- get_metabolite(pl = rep1, mz = 488.2265, rt = 6.31)
print("feature not found in repl. 1")

print("## Cluster_66746/Cluster_149630")
pl_sel <- get_metabolite(pl = rep1, mz = 620.2662, rt = 6.62)
print("## 620.2704/6.83")
print("no corresponding feature in rep1_neg and rep2_neg")
#features[["Cluster_66746/Cluster_149630"]] <- rownames(pl_sel[3, ])

print("## Cluster_67521/Cluster_151820")
pl_sel <- get_metabolite(pl = rep1, mz = 638.2807, rt = 4.87)
print("## 638.2807/4.89")
features[["Cluster_67521/Cluster_151820"]] <- rownames(pl_sel[3, ])

print("## Cluster_67524/Cluster_151820")
pl_sel <- get_metabolite(pl = rep1, mz = 638.2800, rt = 5.06)
print("638.2807/4.89")
features[["Cluster_67524/Cluster_151820"]] <- rownames(pl_sel[4, ])

print("## Cluster_68035/Cluster_153194")
pl_sel <- get_metabolite(pl = rep1, mz = 650.2792, rt = 6.29)
print("## 650.2805/6.28")
print("no corresponding feature in rep1_neg and rep2_neg")
#features[["Cluster_68035/Cluster_153194"]] <- rownames(pl_sel[1, ])

print("## Cluster_68765/Cluster_155231")
pl_sel <- get_metabolite(pl = rep1, mz = 668.2914, rt = 5.10)
print("668.2914/5.10")
print("no corresponding feature in rep1_neg and rep2_neg")
#features[["Cluster_68765/Cluster_155231"]] <- rownames(pl_sel[3, ])

## print features
features

tt <- perform_ttest(features = features, rep1 = rep1, rep1_neg = rep1_neg, 
    rep2_neg = rep2_neg, line = "SALK_037430_4")
print("Col0/SALK_037430")
rmarkdown::paged_table(tt[["col0"]])
print("SALK/SALK_037430_4")
rmarkdown::paged_table(tt[["salk"]])

tt <- perform_ttest(features = features, rep1 = rep1, rep1_neg = rep1_neg, 
    rep2_neg = rep2_neg, line = "SALK_020876_4")
print("Col0/SALK_020876")
rmarkdown::paged_table(tt[["col0"]])
print("SALK/SALK_020876")
rmarkdown::paged_table(tt[["salk"]])

tt <- perform_ttest(features = features, rep1 = rep1, rep1_neg = rep1_neg, 
    rep2_neg = rep2_neg, line = "SALK_027837_5")
print("Col0/SALK_027837")
rmarkdown::paged_table(tt[["col0"]])
print("SALK/SALK_027837")
rmarkdown::paged_table(tt[["salk"]])

tt <- perform_ttest(features = features, rep1 = rep1, rep1_neg = rep1_neg, 
    rep2_neg = rep2_neg, line = "SALK_081021_6")
print("Col0/SALK_081021")
rmarkdown::paged_table(tt[["col0"]])
print("SALK/SALK_081021")
rmarkdown::paged_table(tt[["salk"]])


```

#### SALK_072964

```{r ttests_neg_SALK_072964, echo=FALSE}
features <- list()

print("## Cluster_06135/Cluster_0000812")
pl_sel <- get_metabolite(pl = rep1, mz = 256.5569, rt = 3.70)
print("## feature not found in repl. 1")

print("## Cluster_06643/Cluster_017316")
pl_sel <- get_metabolite(pl = rep1, mz = 271.5621, rt = 3.85)
print("## feature not found in repl. 1")

print("## Cluster_08460/Cluster_022537")
pl_sel <- get_metabolite(pl = rep1, mz = 271.5621, rt = 3.85)
print("## feature not found in repl. 1")

print("## Cluster_10813/Cluster_028030")
pl_sel <- get_metabolite(pl = rep1, mz = 359.5860, rt = 7.00)
print("## feature not found in repl. 1")

print("## Cluster_14676/Cluster_035547")
pl_sel <- get_metabolite(pl = rep1, mz = 443.1012, rt = 4.98)
print("## feature not found in repl. 1")

print("## Cluster_43637/Cluster_019842")
pl_sel <- get_metabolite(pl = rep1, mz = 292.0752, rt = 4.14)
print("292.0752/4.13")
print("no corresponding feature in rep2_neg")
##features[["Cluster_43637/Cluster_019842"]] <- rownames(pl_sel)

print("## Cluster_51292/Cluster_111920")
pl_sel <- get_metabolite(pl = rep1, mz = 386.1802, rt = 2.74)
print("386.1811/2.78")
features[["Cluster_51292/Cluster_111920"]] <- rownames(pl_sel)
#print("no corresponding feature in repl. 2 neg")

print("## Cluster_56806/Cluster_124429")
pl_sel <- get_metabolite(pl = rep1, mz = 455.1151, rt = 3.70)
print("## feature not found in repl. 1")

print("## Cluster_58858/Cluster_129269")
pl_sel <- get_metabolite(pl = rep1, mz = 485.1268, rt = 3.92)
print("485.1268/3.91")
print("no corresponding feature in rep1_neg and rep2_neg")
#features[["Cluster_58858/Cluster_129269"]] <- rownames(pl_sel[3, ])

print("## Cluster_59828/Cluster_131856")
pl_sel <- get_metabolite(pl = rep1, mz = 501.1081, rt = 3.70)
print("## feature not found in repl. 1")

print("## Cluster_60920/Cluster_134545")
pl_sel <- get_metabolite(pl = rep1, mz = 517.0833, rt = 3.70)
print("## feature not found in repl. 1")

print("## Cluster_61036/Cluster_134803")
pl_sel <- get_metabolite(pl = rep1, mz = 518.2228, rt = 2.99)
print("518.2235/3.28")
features[["Cluster_61036/Cluster_134803"]] <- rownames(pl_sel)
#print("no corresponding feature in rep2_neg")

#print("## Cluster_61038/Cluster_134803")
#pl_sel <- get_metabolite(pl = rep1, mz = 518.2225, rt = 3.25)
#print("518.2235/3.28")
#features[["Cluster_61038/Cluster_134803"]] <- rownames(pl_sel)

print("## Cluster_62024/Cluster_137155")
pl_sel <- get_metabolite(pl = rep1, mz = 533.0576, rt = 3.70)
print("## feature not found in repl. 1")

print("## Cluster_62414/Cluster_138008")
pl_sel <- get_metabolite(pl = rep1, mz = 538.1556, rt = 5.04)
print("538.1556/5.04")
print("no corresponding feature in rep2_neg")
#features[["Cluster_62414/Cluster_138008"]] <- rownames(pl_sel[2, ])

print("## Cluster_62876/Cluster_139378")
pl_sel <- get_metabolite(pl = rep1, mz = 547.0962, rt = 3.85)
print("## feature not found in repl. 1")

print("## Cluster_62980/Cluster_139652")
pl_sel <- get_metabolite(pl = rep1, mz = 548.2337, rt = 3.40)
print("## 548.2337/3.39")
#features[["Cluster_62980/Cluster_139652"]] <- rownames(pl_sel)
print("no corresponding feature in negative repl. 1 and repl. 2")

print("## Cluster_62981/Cluster_139652")
pl_sel <- get_metabolite(pl = rep1, mz = 548.2337, rt = 3.40)
print("## 548.2337/3.39")
#features[["Cluster_62981/Cluster_139652"]] <- rownames(pl_sel)
print("no corresponding feature in negative repl. 1 and repl. 2")

print("## Cluster_67946/Cluster_152970")
pl_sel <- get_metabolite(pl = rep1, mz = 648.2383, rt = 5.03)
print("## feature not found in repl. 1")

print("## Cluster_70637/Cluster_160826")
pl_sel <- get_metabolite(pl = rep1, mz = 724.2813, rt = 6.03)
print("## 724.2813/6.03")
#features[["Cluster_70637/Cluster_160826"]] <- rownames(pl_sel)
print("no corresponding feature in negative repl. 1 and repl. 2")

print("## Cluster_70643/Cluster_160829")
pl_sel <- get_metabolite(pl = rep1, mz = 724.3156, rt = 7.53)
print("## feature not found in repl. 1")

print("## Cluster_70645/Cluster_160827")
pl_sel <- get_metabolite(pl = rep1, mz = 724.3160, rt = 7.40)
print("## feature not found in repl. 1")

print("## Cluster_74283/Cluster_171756")
pl_sel <- get_metabolite(pl = rep1, mz = 872.3333, rt = 7.45)
print("## 872.3333/7.45")
#features[["Cluster_74283/Cluster_171756"]] <- rownames(pl_sel)
print("no corresponding feature in negative repl. 1 and repl. 2")

print("## Cluster_74692/Cluster_172731")
pl_sel <- get_metabolite(pl = rep1, mz = 890.3421, rt = 6.20)
print("## feature not found in repl. 1")

## print features
features

tt <- perform_ttest(features = features, rep1 = rep1, rep1_neg = rep1_neg, 
    rep2_neg = rep2_neg, line = "SALK_072964_5")
print("Col0")
rmarkdown::paged_table(tt[["col0"]])
print("SALK")
rmarkdown::paged_table(tt[["salk"]])
```

#### SALK_024438

```{r ttests_pos_SALK_024438, echo=FALSE}
features <- list()

print("## Cluster_17329/Cluster_040833")
pl_sel <- get_metabolite(pl = rep1, mz = 517.0257, rt = 6.39)
print("## 517.0257/6.38")
features[["Cluster_17329/Cluster_040833"]] <- rownames(pl_sel)

print("## Cluster_26090/Cluster_056574")
pl_sel <- get_metabolite(pl = rep1, mz = 117.0575, rt = 6.37)
print("## 117.0575/6.38")
features[["Cluster_26090/Cluster_056574"]] <- rownames(pl_sel)

print("## Cluster_27226/Cluster_059204")
pl_sel <- get_metabolite(pl = rep1, mz = 130.0652, rt = 6.38)
print("130.0652/6.38")
features[["Cluster_27226/Cluster_059204"]] <- rownames(pl_sel[1, ])

print("## Cluster_30238/Cluster_066189")
pl_sel <- get_metabolite(pl = rep1, mz = 160.0757, rt = 6.37)
print("## 160.0757/6.38")
features[["Cluster_30238/Cluster_066189"]] <- rownames(pl_sel[3, ])

print("## Cluster_34740/Cluster_075680")
pl_sel <- get_metabolite(pl = rep1, mz = 206.0507, rt = 6.38)
print("## 206.0507/6.38")
features[["Cluster_34740/Cluster_075680"]] <- rownames(pl_sel)

print("## Cluster_37887/Cluster_081532")
pl_sel <- get_metabolite(pl = rep1, mz = 237.0688, rt = 6.33)
print("## 237.0691/6.38")
features[["Cluster_37887/Cluster_081532"]] <- rownames(pl_sel[1, ])

print("## Cluster_50972/Cluster_111188")
pl_sel <- get_metabolite(pl = rep1, mz = 383.1272, rt = 6.37)
print("## 383.1272/6.38")
#features[["Cluster_50972/Cluster_111188"]] <- rownames(pl_sel)
print("no corresponding feature in negative mode in rep1_neg and rep2_neg")

print("## Cluster_52306/Cluster_114291")
pl_sel <- get_metabolite(pl = rep1, mz = 399.1222, rt = 6.38)
print("399.1222/6.38")
features[["Cluster_52306/Cluster_114291"]] <- rownames(pl_sel[1, ])

print("## Cluster_53874/Cluster_117717")
pl_sel <- get_metabolite(pl = rep1, mz = 417.1407, rt = 8.21)
print("## 417.1407/8.21")
#features[["Cluster_53874/Cluster_117717"]] <- rownames(pl_sel[2, ])
print("no corresponding feature in negative mode in rep1_neg and rep2_neg")

print("## ## Cluster_54142/Cluster_118315")
pl_sel <- get_metabolite(pl = rep1, mz = 421.1041, rt = 6.38)
print("## 421.1041/6.38")
features[["Cluster_54142/Cluster_118315"]] <- rownames(pl_sel[1, ])

print("## Cluster_63530/Cluster_140991")
pl_sel <- get_metabolite(pl = rep1, mz = 558.0525, rt = 6.39)
print("558.0525/6.38")
features[["Cluster_63530/Cluster_140991"]] <- rownames(pl_sel[2, ])

## print features
features

tt <- perform_ttest(features = features, rep1 = rep1, rep1_neg = rep1_neg, 
    rep2_neg = rep2_neg, line = "SALK_024438_5")
print("Col0")
rmarkdown::paged_table(tt[["col0"]])
print("SALK")
rmarkdown::paged_table(tt[["salk"]])
```


#### SALK_011180/SALK_021216/SALK_049338


```{r ttests_pos_salk_011180_salk_021216_salk_049338, echo = FALSE}
features <- list()

print("## Cluster_06008/Cluster_014813")
pl_sel <- get_metabolite(pl = rep1, mz = 252.0279, rt = 6.95)
print("## feature not found in repl. 1")

print("## Cluster_06009/Cluster_014823")
pl_sel <- get_metabolite(pl = rep1, mz = 252.0277, rt = 6.05)
print("## feature not found in repl. 1")

print("## Cluster_06373/Cluster_016278")
pl_sel <- get_metabolite(pl = rep1, mz = 264.5441, rt = 7.73)
print("264.5441/7.73")
#features[["Cluster_06373/Cluster_016278"]] <- rownames(pl_sel[1, ])
print("## no corresponding feature in negative mode in rep1_neg and rep2_neg")

print("## Cluster_06681/Cluster_017447")
pl_sel <- get_metabolite(pl = rep1, mz = 272.5417, rt = 7.08)
print("## 272.5417/7.08")
features[["Cluster_06681/Cluster_017447"]] <- rownames(pl_sel[2, ])

print("## Cluster_06683/Cluster_088569")
pl_sel <- get_metabolite(pl = rep1, mz = 272.5416, rt = 6.19)
print("# 272.5416/6.19")
features[["Cluster_06683/Cluster_088569"]] <- rownames(pl_sel[1, ])

print("## Cluster_06986/Cluster_018383")
pl_sel <- get_metabolite(pl = rep1, mz = 280.5279, rt = 7.07)
print("280.5279/7.07")
features[["Cluster_06986/Cluster_018383"]] <- rownames(pl_sel[3, ])

print("## Cluster_06988/Cluster_018381")
pl_sel <- get_metabolite(pl = rep1, mz = 280.5278, rt = 6.19)
#print("## 280.5278/6.19")
#features[["Cluster_06988/Cluster_018381"]] <- rownames(pl_sel[2, ])
print("## no corresponding feature in negative mode in rep1_neg and rep2_neg")

print("## Cluster_07141/Cluster_018968")
pl_sel <- get_metabolite(pl = rep1, mz = 285.0575, rt = 7.73)
#print("285.0575/7.73")
#features[["Cluster_07141/Cluster_018968"]] <- rownames(pl_sel[1, ])
print("no corresponding feature found in rep1_neg and rep2_neg")

print("## Cluster_07450/Cluster_020032")
pl_sel <- get_metabolite(pl = rep1, mz = 293.0544, rt = 6.95)
print("## feature not found in repl. 1")

print("## Cluster_07452/Cluster_020029")
pl_sel <- get_metabolite(pl = rep1, mz = 293.0550, rt = 6.20)
#print("## 293.0550/6.19")
#features[["Cluster_07452/Cluster_020029"]] <- rownames(pl_sel)
print("## no corresponding feature in negative mode in rep1_neg and rep2_neg")

print("## Cluster_08668/Cluster_022989")
pl_sel <- get_metabolite(pl = rep1, mz = 316.0516, rt = 6.05)
print("## feature not found in repl. 1")

print("## Cluster_08715/Cluster_023102")
pl_sel <- get_metabolite(pl = rep1, mz = 317.0687, rt = 6.19)
#print("317.0687/6.19")
#features[["Cluster_08715/Cluster_023102"]] <- rownames(pl_sel[2, ])
print("## no corresponding feature in negative mode in rep1_neg and rep2_neg")

print("## Cluster_08716/Cluster_023104")
pl_sel <- get_metabolite(pl = rep1, mz = 317.0600, rt = 6.65)
print("317.0600/6.65")
features[["Cluster_08716/Cluster_023104"]] <- rownames(pl_sel[1, ])

print("## Cluster_09093/Cluster_024151")
pl_sel <- get_metabolite(pl = rep1, mz = 280.5279, rt = 7.07)
print("## 280.5279/7.07")
print("feature already selected (Cluster_06986/Cluster_018383)")
##features[["Cluster_09093/Cluster_024151"]] <- rownames(pl_sel[3, ])

print("## Cluster_09094/Cluster_024158")
pl_sel <- get_metabolite(pl = rep1, mz = 325.0573, rt = 6.19)
print("## 325.0573/6.19")
features[["Cluster_09094/Cluster_024158"]] <- rownames(pl_sel[1, ])

print("## Cluster_09432/Cluster_024930")
pl_sel <- get_metabolite(pl = rep1, mz = 332.0652, rt = 6.80)
#print("## 332.0652/6.80")
#features[["Cluster_09432/Cluster_024930"]] <- rownames(pl_sel[1, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_09699/Cluster_025580")
pl_sel <- get_metabolite(pl = rep1, mz = 337.5724, rt = 6.43)
print("## 337.5731/6.65")
features[["Cluster_09699/Cluster_025580"]] <- rownames(pl_sel[1, ])

print("## Cluster_10037/Cluster_026320")
pl_sel <- get_metabolite(pl = rep1, mz = 344.0296, rt = 6.05)
print("## feature not found in repl. 1")

print("## Cluster_10100/Cluster_026502")
pl_sel <- get_metabolite(pl = rep1, mz = 345.5706, rt = 6.19)
print("## 345.57/6.19")
features[["Cluster_10100/Cluster_026502"]] <- rownames(pl_sel[1, ])

print("## Cluster_10181/Cluster_026758")
pl_sel <- get_metabolite(pl = rep1, mz = 347.5665, rt = 6.05)
print("## feature not found in repl. 1")

print("## Cluster_10475/Cluster_027427")
pl_sel <- get_metabolite(pl = rep1, mz = 353.5568, rt = 6.19)
#print("# 353.5568/6.19")
#features[["Cluster_10475/Cluster_027427"]] <- rownames(pl_sel[1, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_10527/Cluster_027529")
pl_sel <- get_metabolite(pl = rep1, mz = 354.5584, rt = 6.19)
#print("## 354.5584/371.5415")
#features[["Cluster_10527/Cluster_027529"]] <- rownames(pl_sel[1, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_10723/Cluster_027886")
pl_sel <- get_metabolite(pl = rep1, mz = 358.0864, rt = 6.73)
print("## 358.0864/6.73")
features[["Cluster_10723/Cluster_027886"]] <- rownames(pl_sel[1, ])

print("## Cluster_10854/Cluster_028123")
pl_sel <- get_metabolite(pl = rep1, mz = 360.5646, rt = 6.80)
#print("## 360.5646/6.79")
#features[["Cluster_10854/Cluster_028123"]] <- rownames(pl_sel[1, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_11067/Cluster_028666")
pl_sel <- get_metabolite(pl = rep1, mz = 366.0840, rt = 6.19)
#print("## SALK_011180_5, 366.0840/6.19")
#features[["Cluster_11067/Cluster_028666"]] <- rownames(pl_sel[1, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_11415/Cluster_029357")
pl_sel <- get_metabolite(pl = rep1, mz = 373.0919, rt = 6.80)
#print("## 373.0919/6.78")
#features[["Cluster_11415/Cluster_029357"]] <- rownames(pl_sel[1, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_13438/Cluster_033216")
pl_sel <- get_metabolite(pl = rep1, mz = 415.0883, rt = 6.05)
print("feature not found in repl. 1")

print("## Cluster_13467/Cluster_033297")
pl_sel <- get_metabolite(pl = rep1, mz = 416.0458, rt = 6.05)
print("feature not found in repl. 1")

print("## Cluster_15664/Cluster_037416")
pl_sel <- get_metabolite(pl = rep1, mz = 468.0805, rt = 6.95)
print("feature not found in repl. 1")

print("## Cluster_19567/Cluster_046010")
pl_sel <- get_metabolite(pl = rep1, mz = 630.1343, rt = 6.20)
#print("## SALK_011180, 630.1343/6.19")
#features[["Cluster_19567/Cluster_046010"]] <- rownames(pl_sel[1, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_19968/Cluster_046902")
pl_sel <- get_metabolite(pl = rep1, mz = 657.0921, rt = 6.05)
print("feature not found in repl. 1")

print("## Cluster_20043/Cluster_047088")
pl_sel <- get_metabolite(pl = rep1, mz = 664.0721, rt = 6.19)
print("## SALK_011180, 665.0721/6.19")
#features[["Cluster_20043/Cluster_047088"]] <- rownames(pl_sel[1, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_20408/Cluster_157992")
pl_sel <- get_metabolite(pl = rep1, mz = 695.1127, rt = 6.19)
#print("## 696.1127/6.19")
#features[["Cluster_20408/Cluster_157992"]] <- rownames(pl_sel[1, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_22101/Cluster_000699")
pl_sel <- get_metabolite(pl = rep1, mz = 902.1905, rt = 6.05)
print("## feature not found in repl. 1")

print("## Cluster_22316/Cluster_051425")
pl_sel <- get_metabolite(pl = rep1, mz = 928.6465, rt = 6.05)
print("## feature not found in repl. 1")

print("## Cluster_43184/Cluster_091479")
pl_sel <- get_metabolite(pl = rep1, mz = 287.0545, rt = 6.65)
print("## 287.0545/6.65")
features[["Cluster_43184/Cluster_091479"]] <- rownames(pl_sel[2, ])

print("## Cluster_43185/Cluster_091480")
pl_sel <- get_metabolite(pl = rep1, mz = 287.0545, rt = 6.65)
#features[["Cluster_43185/Cluster_091480"]] <- rownames(pl_sel[1, ])
#print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_43188/Cluster_091475")
pl_sel <- get_metabolite(pl = rep1, mz = 287.0543, rt = 7.42)
#print("## 287.0547/7.42")
#features[["Cluster_43188/Cluster_091475"]] <- rownames(pl_sel[1, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_44662/Cluster_094789")
pl_sel <- get_metabolite(pl = rep1, mz = 303.0494, rt = 6.19)
#print("## 303.0494/6.19")
#features[["Cluster_44662/Cluster_094789"]] <- rownames(pl_sel[1, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_44666/Cluster_094774")
pl_sel <- get_metabolite(pl = rep1, mz = 303.0498, rt = 7.08)
print("## 303.0498/7.08")
features[["Cluster_44666/Cluster_094774"]] <- rownames(pl_sel[5, ])

print("## Cluster_55107/Cluster_120576")
pl_sel <- get_metabolite(pl = rep1, mz = 433.1120, rt = 6.43)
print(" feature not found in repl. 1")

print("## Cluster_55108/Cluster_120556")
pl_sel <- get_metabolite(pl = rep1, mz = 433.1120, rt = 6.52)
#print("## 433.1133/6.93") ## 2
#features[["Cluster_55108/Cluster_120556"]] <- rownames(pl_sel[2, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_56343/Cluster_123342")
pl_sel <- get_metabolite(pl = rep1, mz = 449.1086, rt = 7.73)
print("## 449.1086/7.73") ## 3
#features[["Cluster_56343/Cluster_123342"]] <- rownames(pl_sel[3, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_56344/Cluster_123331")
pl_sel <- get_metabolite(pl = rep1, mz = 449.1068, rt = 5.98)
print("## 449.1079/5.51") ## 3
#features[["Cluster_56344/Cluster_123331"]] <- rownames(pl_sel[3, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_56345/Cluster_123332")
pl_sel <- get_metabolite(pl = rep1, mz = 449.1079, rt = 6.19)
print("## 449.1079/6.19")
features[["Cluster_56345/Cluster_123332"]] <- rownames(pl_sel[2, ])

print("## Cluster_57375/Cluster_037036")
pl_sel <- get_metabolite(pl = rep1, mz = 463.1236, rt = 6.79)
print("## 363.1236/6.79") ## 3
#features[["Cluster_57375/Cluster_037036"]] <- rownames(pl_sel[3, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_57509/Cluster_126071")
pl_sel <- get_metabolite(pl = rep1, mz = 465.1032, rt = 7.08)
print("## 465.1032/7.08") ## 1
#features[["Cluster_57509/Cluster_126071"]] <- rownames(pl_sel[1, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_57936/Cluster_127083")
pl_sel <- get_metabolite(pl = rep1, mz = 471.0901, rt = 7.73)
print("## 471.0901/7.72")
#features[["Cluster_57936/Cluster_127083"]] <- rownames(pl_sel[1, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_63023/Cluster_139719")
pl_sel <- get_metabolite(pl = rep1, mz = 549.0543, rt = 6.95)
print("feature not found in repl. 1")

print("## Cluster_64085/Cluster_142200")
pl_sel <- get_metabolite(pl = rep1, mz = 566.0442, rt = 6.95)
print("feature not found in repl. 1")

print("## Cluster_65227/Cluster_145311")
pl_sel <- get_metabolite(pl = rep1, mz = 589.0503, rt = 6.05)
print("feature not found in repl. 1")

print("## Cluster_65613/Cluster_146143")
pl_sel <- get_metabolite(pl = rep1, mz = 595.1670, rt = 6.73)
print("## 595.1670/6.73")
features[["Cluster_65613/Cluster_146143"]] <- rownames(pl_sel[1, ])

print("## Cluster_66352/Cluster_148405")
pl_sel <- get_metabolite(pl = rep1, mz = 611.1589, rt = 6.19)
print("## 611.1617/6.19")
features[["Cluster_66352/Cluster_148405"]] <- rownames(pl_sel[1, ])

print("## Cluster_66607/Cluster_149177")
pl_sel <- get_metabolite(pl = rep1, mz = 617.1478, rt = 6.73)
print("## 617.1478/6.73")
features[["Cluster_66607/Cluster_149177"]] <- rownames(pl_sel[1, ])

print("## Cluster_67054/Cluster_150397")
pl_sel <- get_metabolite(pl = rep1, mz = 625.1768, rt = 6.79)
print("## 625.1786/6.78") ## 1
#features[["Cluster_67054/Cluster_150397"]] <- rownames(pl_sel[1, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_67054/Cluster_150397")
pl_sel <- get_metabolite(pl = rep1, mz = 627.1557, rt = 5.10)
print("# 627.1557/5.10")
#features[["Cluster_67054/Cluster_150397"]] <- rownames(pl_sel[1, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_67262/Cluster_151134")
pl_sel <- get_metabolite(pl = rep1, mz = 633.1427, rt = 6.19)
print("## 633.1427/6.19")
features[["Cluster_67262/Cluster_151134"]] <- rownames(pl_sel[1, ])

print("## Cluster_67877/Cluster_152801")
pl_sel <- get_metabolite(pl = rep1, mz = 647.1585, rt = 6.79)
print("## 647.1585/6.78")
#features[["Cluster_67877/Cluster_152801"]] <- rownames(pl_sel)
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_67970/Cluster_153028")
pl_sel <- get_metabolite(pl = rep1, mz = 649.1136, rt = 6.19)
print("## 649.1163/6.19")
features[["Cluster_67970/Cluster_153028"]] <- rownames(pl_sel[1, ])

print("## Cluster_68272/Cluster_153802")
pl_sel <- get_metabolite(pl = rep1, mz = 656.2174, rt = 6.05)
print("## feature not found in repl. 1")

print("## Cluster_69853/Cluster_158605")
pl_sel <- get_metabolite(pl = rep1, mz = 701.0564, rt = 6.19)
print("## 701.0564/6.19")
#features[["Cluster_69853/Cluster_158605"]] <- rownames(pl_sel[1, ])
print("no corresponding feature in rep1_neg and rep2_neg")

print("## Cluster_70251/Cluster_159652")
pl_sel <- get_metabolite(pl = rep1, mz = 712.1015, rt = 6.05)
print("## feature not found in repl. 1")

print("## Cluster_779.0616/Cluster_165448")
pl_sel <- get_metabolite(pl = rep1, mz = 779.0616, rt = 6.05)
print("## feature not found in repl. 1")

## print features
features

tt <- perform_ttest(features = features, rep1 = rep1, rep1_neg = rep1_neg, 
    rep2_neg = rep2_neg, line = "SALK_011180_5")
print("Col0/SALK_011180_5")
rmarkdown::paged_table(tt[["col0"]])
print("SALK/SALK_011180_5")
rmarkdown::paged_table(tt[["salk"]])

tt <- perform_ttest(features = features, rep1 = rep1, rep1_neg = rep1_neg, 
    rep2_neg = rep2_neg, line = "SALK_021216_4")
print("Col0/SALK_021216_4")
rmarkdown::paged_table(tt[["col0"]])
print("SALK/SALK_021216_4")
rmarkdown::paged_table(tt[["salk"]])

tt <- perform_ttest(features = features, rep1 = rep1, rep1_neg = rep1_neg, 
    rep2_neg = rep2_neg, line = "SALK_049338_4")
print("Col0/SALK_049338_4")
rmarkdown::paged_table(tt[["col0"]])
print("SALK/SALK_049338_4")
rmarkdown::paged_table(tt[["salk"]])
```



### Create plots 


```{r plots_positive, echo = FALSE}
create_plot <- function(feature_rep1 = "feature_15191", 
    feature_rep1_neg = "feature_17824", feature_rep2_neg = "feature_15564", 
    line = "SALK_081021") {
    
    
    col0 <- c("Col_0_1", "Col_0_2", "Col_0_3", "Col_0_4", "Col_0_5", "Col_0_6",
        "Col_0_7", "Col_0_8", "Col_0_9", "Col_0_10")
    other_salk_lines <- c("mz", "rt", "npeaks", "adduct", "pcgroup", 
        "mapping_rep1_rep2", "cor", "rt_dev", "mz_dev", col0, line)
    salk_rep1 <- !grepl(colnames(rep1), 
        pattern = paste(other_salk_lines, collapse = "|"))
    salk_rep1_neg <- !grepl(colnames(rep1_neg), 
        pattern = paste(other_salk_lines, collapse = "|"))
    salk_rep2_neg <- !grepl(colnames(rep2_neg), 
        pattern = paste(other_salk_lines, collapse = "|"))
    rep1_feat <- rep1[feature_rep1, ]
    rep1_neg_feat <- rep1_neg[feature_rep1_neg, ]
    rep2_neg_feat <- rep2_neg[feature_rep2_neg, ]
    
    df <- rbind(
        cbind(type = "Col-0", rep = "rep. 1",
            values = as.numeric(rep1_feat[, col0])),
        cbind(type = "SALK", rep = "rep. 1", 
            values = as.numeric(rep1_feat[, salk_rep1])),
        cbind(type = "Col-0", rep = "rep. 1 neg",
            values = as.numeric(rep1_neg_feat[, col0])),
        cbind(type = "SALK", rep = "rep. 1 neg", 
            values = as.numeric(rep1_neg_feat[, salk_rep1_neg])),
        cbind(type = "Col-0", rep = "rep. 2 neg", 
            values = as.numeric(rep2_neg_feat[, col0])),
        cbind(type = "SALK", rep = "rep. 2 neg",
            values = as.numeric(rep2_neg_feat[, salk_rep2_neg]))
    ) |>
        data.frame()
    
    for (i in line) {
        df_i <- rbind(
            cbind(type = i, rep = "rep. 1", values = as.numeric(
                rep1_feat[, grep(colnames(rep1), pattern = i)])),
            cbind(type = i, rep = "rep. 1 neg", values = as.numeric(
                rep1_neg_feat[, grep(colnames(rep1_neg), pattern = i)])),
            cbind(type = i, rep = "rep. 2 neg", values = as.numeric(
                rep2_neg_feat[, grep(colnames(rep2_neg), pattern = i)]))
        )
        df <- rbind(df, df_i)
    }
    df$values <- as.numeric(df$values)
    df$type <- factor(df$type, levels = c("Col-0", "SALK", line))
    
    ## replace rep. 1, rep. 1 neg and rep. 2 neg by information on metabolites 
    ## (feature name, mz, rt)
    df$rep[df$rep == "rep. 1"] <- paste(
        feature_rep1, ", rep. 1<br>", "(*m/z* ", round(rep1_feat[, "mz"], 4), 
        ", ", round(rep1_feat[, "rt"] / 60, 2), " min)", sep = "")
    df$rep[df$rep == "rep. 1 neg"] <- paste(
        feature_rep1_neg, ", rep. 1 neg<br>", "(*m/z* ", 
        round(rep1_neg_feat[, "mz"], 4), ", ", 
        round(rep1_neg_feat[, "rt"] / 60, 2), " min)", sep = "")
    df$rep[df$rep == "rep. 2 neg"] <- paste(
        feature_rep2_neg, ", rep. 2 neg<br>", "(*m/z* ", 
        round(rep2_neg_feat[, "mz"], 4), ", ", 
        round(rep2_neg_feat[, "rt"] / 60, 2), " min)", sep = "")
    df$rep <- factor(df$rep, levels = unique(df$rep))
    
    ## plot
    ggplot(df, aes(x = type, y = values)) +
        geom_boxplot() +
        facet_wrap( ~ rep) +
        xlab("") + ylab("log<sub>2</sub>-normalized intensities") +
        #ggtitle(title_plot) +
        mdthemes::md_theme_bw() +
        mdthemes::as_md_theme(theme(
            axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
            plot.title = element_text(size = 8)))
}
## SALK_008908
create_plot(feature_rep1 = "feature_6235", feature_rep1_neg = "feature_10405",
            feature_rep2_neg = "feature_8298", line = "SALK_008908")

## SALK_081021
create_plot(feature_rep1 = "feature_15191", 
    feature_rep1_neg = "feature_17824", feature_rep2_neg = "feature_15564",
    line = "SALK_081021")

## SALK_024438
create_plot(feature_rep1 = "feature_19111", 
    feature_rep1_neg = "feature_13198", feature_rep2_neg = "feature_10756",
    line = "SALK_024438")
create_plot(feature_rep1 = "feature_744", 
    feature_rep1_neg = "feature_13198", feature_rep2_neg = "feature_10756",
    line = "SALK_024438")
create_plot(feature_rep1 = "feature_1990", 
    feature_rep1_neg = "feature_13198", feature_rep2_neg = "feature_10756",
    line = "SALK_024438")
create_plot(feature_rep1 = "feature_13137", 
    feature_rep1_neg = "feature_13198", feature_rep2_neg = "feature_10756",
    line = "SALK_024438")
create_plot(feature_rep1 = "feature_14318", 
    feature_rep1_neg = "feature_13198", feature_rep2_neg = "feature_10756",
    line = "SALK_024438")
create_plot(feature_rep1 = "feature_20785", 
    feature_rep1_neg = "feature_13198", feature_rep2_neg = "feature_10756",
    line = "SALK_024438")

## SALK_049338
create_plot(feature_rep1 = "feature_6559", 
    feature_rep1_neg = "feature_15393", feature_rep2_neg = "feature_12897",
    line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_6558", 
    feature_rep1_neg = "feature_18237", feature_rep2_neg = "feature_16038",
    line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_6914", 
    feature_rep1_neg = "feature_15393", feature_rep2_neg = "feature_12897",
    line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_9030", 
    feature_rep1_neg = "feature_20453", feature_rep2_neg = "feature_18573",
    line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_9827", 
    feature_rep1_neg = "feature_19905", feature_rep2_neg = "feature_17945",
    line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0
create_plot(feature_rep1 = "feature_10280", 
    feature_rep1_neg = "feature_20453", feature_rep2_neg = "feature_18573",
    line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_8025", 
    feature_rep1_neg = "feature_15393", feature_rep2_neg = "feature_12897",
    line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
# create_plot(feature_rep1 = "feature_15861", 
#     feature_rep1_neg = "feature_19416", feature_rep2_neg = "feature_17374",
#     line = c("SALK_011180", "SALK_021216", "SALK_049338")) +## Col0, SALK

    
    
create_plot(feature_rep1 = "feature_22378", 
    feature_rep1_neg = "feature_19416", feature_rep2_neg = "feature_17374",
    line = c("SALK_011180", "SALK_021216", "SALK_049338")) +## Col0, SALK
    ggsignif::geom_signif(stat = "identity",
        data = data.frame(x = c(1), xend = c(5), y = c(21.5), annotation = c("***"),
            rep = factor("feature_22378, rep. 1<br>(*m/z* 611.1617, 6.19 min)")),
            aes(x=x, xend=xend, y=y, yend=y, annotation=annotation)) +
    ggsignif::geom_signif(stat = "identity",
        data = data.frame(x = c(2), xend = c(5), y = c(21.0), annotation = c("***"),
            rep = factor("feature_22378, rep. 1<br>(*m/z* 611.1617, 6.19 min)")),
            aes(x=x, xend=xend, y=y, yend=y, annotation=annotation)) +
        ylim(12, 22)
    
    
    
create_plot(feature_rep1 = "feature_22565", 
    feature_rep1_neg = "feature_19905", feature_rep2_neg = "feature_17945",
    line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0
create_plot(feature_rep1 = "feature_23035", 
    feature_rep1_neg = "feature_20453", feature_rep2_neg = "feature_18573",
    line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
create_plot(feature_rep1 = "feature_23441", 
    feature_rep1_neg = "feature_20453", feature_rep2_neg = "feature_18573",
    line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK

create_plot(feature_rep1 = "feature_21907", 
    feature_rep1_neg = "feature_17646", feature_rep2_neg = "feature_15328",
    line = c("SALK_011180", "SALK_021216", "SALK_049338")) ## Col0, SALK
```